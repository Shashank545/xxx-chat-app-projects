(window.msfast_searchux_sb_jsonp=window.msfast_searchux_sb_jsonp||[]).push([["events-logger"],{"sU/U":function(t,e,n){"use strict";n.r(e),n.d(e,"default",(function(){return A}));var r=n("+zb2"),o=n("Bu7D"),i=n("KUM7"),s=n("W4Bk"),a=n("Ee7w"),c=n("ozfy");function u(t,e,n,o,i,s){void 0===n&&(n=t);var u,l,f,d,v,g=!1,b=!1;function _(t){return t.then((function(t){return T(),t}),(function(t){throw T(),t}))}function T(){if(i&&u){var t=l||h(u,!1,"soft timeout; retry succeeded");i(t,d,v)}}function p(){return Object(r.__awaiter)(this,void 0,void 0,(function(){var e,a,c;return Object(r.__generator)(this,(function(r){switch(r.label){case 0:u={startTime:new Date},r.label=1;case 1:return r.trys.push([1,3,,8]),[4,t()];case 2:return a=r.sent(),g=!0,i&&(l=h(u,!0)),[2,a];case 3:if(e=r.sent(),i&&(l=h(u,!1,e)),s||o&&e&&o(e))return b=!0,[2,Promise.reject(e)];if(b)return[2,Promise.reject("Another retry has already been attempted.")];b=!0,f={startTime:new Date,isDelayedRetry:!1},r.label=4;case 4:return r.trys.push([4,6,,7]),[4,n()];case 5:return a=r.sent(),v=!g,g=!0,i&&(d=h(f,!0)),[2,a];case 6:return c=r.sent(),i&&(d=h(f,!1,c)),[2,Promise.reject(c)];case 7:return[3,8];case 8:return[2]}}))}))}if(!e)return _(p());var m,k=new Promise((function(t,r){function o(){if(g||b)return clearInterval(s),clearTimeout(a),r()}var s=setInterval(o,20);o();var a=setTimeout((function(){if(clearInterval(s),g||b)return r();b=!0,f={startTime:new Date,isDelayedRetry:!0},n().then((function(e){i&&f&&(v=!g,d=h(f,!0)),t(e)}),(function(t){i&&f&&(d=h(f,!1,t)),r(t)}))}),e)}));return _((m=[p(),k],new Promise((function(t,e){var n,r=0,o=Object(a.a)(m);0===o&&t(),Object(c.a)(m,(function(i){i.then((function(e){return t(e)}),(function(t){if(r++,null!=t&&(n=t),r>=o)return e(n)}))}))}))))}function h(t,e,n){return Object(r.__assign)(Object(r.__assign)({},t),{durationInMs:(new Date).getTime()-t.startTime.getTime(),succeeded:e,error:n})}var l=n("4Nfb"),f=n("GFGo"),d=n("BsjR"),v=n("L1IH"),g=n("iVFh"),b=n("28CS"),_=function(){function t(t,e,n){this.getAccessTokenAsync=t,this.getAccessToken=e,this.getRawAccessToken=n}return t.prototype.getToken=function(){if(this.getRawAccessToken)return this.getRawAccessToken();if(this.substrateToken&&this.hasValidToken())return this.substrateToken.token;if(this.getAccessToken){var t=this.getAccessToken();if(t)return this.setToken(t),t.token}},t.prototype.getTokenAsync=function(){return Object(r.__awaiter)(this,void 0,void 0,(function(){var t;return Object(r.__generator)(this,(function(e){switch(e.label){case 0:if(this.substrateToken&&this.hasValidToken())return[2,this.substrateToken.token];if(!this.getAccessTokenAsync)throw Error("SubstrateTokenProvider: getAccessTokenAsync is undefined");return[4,this.getAccessTokenAsync()];case 1:return t=e.sent(),this.setToken(t),[2,t.token]}}))}))},t.prototype.setToken=function(t){this.substrateToken=t},t.prototype.hasValidToken=function(){return!(!this.substrateToken||!this.substrateToken.tokenExpiry)&&this.substrateToken.tokenExpiry>(new Date).getTime()},t}(),T=function(){function t(t,e,n,r,o,i,s,a,c,u,h){void 0===i&&(i=1e3),this.scenarioName=t,this._getAuthTokenAsync=e,this._getAuthToken=n,this._getRawAuthToken=r,this.isTokenValidationEnabled=o,this._batchTimeout=i,this._xAnchorMailbox=s,this.locale=a,this.substrateHostName=c,this.useNoBearerAuth=u,this.log3sError=h,this._batch={},this._retriesRemaining=4,this._logBatchAfterTimeout=0,this._timerIsRunning=!1,this._localStorageAvailable=!1,this.isTokenValidationEnabled&&(this._substrateTokenProvider=new _(this._getAuthTokenAsync,this._getAuthToken,this._getRawAuthToken)),this._localStorageAvailable="undefined"!=typeof localStorage&&!!localStorage,this.getBatchFromLocalStorage()}return t.prototype.log3SEvent=function(t,e){this.logEvent(t,e,t.EventKey)},t.prototype.logEvent=function(t,e,n){this.addEvent(this.scenarioName,e,this.formatEvent(t),n),this._timerIsRunning||(this.resetRetryCounter(),this.startTimer())},t.prototype.flush=function(){return Object(r.__awaiter)(this,void 0,void 0,(function(){return Object(r.__generator)(this,(function(t){switch(t.label){case 0:return clearTimeout(this._logBatchAfterTimeout),[4,this.logBatch()];case 1:return t.sent(),[2]}}))}))},t.prototype.dispose=function(){clearTimeout(this._logBatchAfterTimeout),this.batchFlush()},t.prototype.getBatch=function(){return this._batch},t.prototype.testMergeBack=function(){var t=this,e=this.getBatchToSend();Object(c.a)(e,(function(e){t.mergeBack(e.scenario,e.ebatch)}))},t.prototype.batchFlush=function(){var t,e,n=this;if(!Object(d.a)(this._batch)){var o,i,s;if(this.getBatchFromLocalStorage(!1),this.isTokenValidationEnabled&&this._substrateTokenProvider)(s=null===(t=this._substrateTokenProvider)||void 0===t?void 0:t.getToken())||""===s?o=s:i=null===(e=this._substrateTokenProvider)||void 0===e?void 0:e.getTokenAsync;else(s=this.getToken(!0))?o=s:i=function(){return Object(r.__awaiter)(n,void 0,void 0,(function(){var t,e=this;return Object(r.__generator)(this,(function(n){switch(n.label){case 0:return[4,this.refreshToken().catch((function(t){e.logError("3sEventsAPI: failed to get async token",t)}))];case 1:return[2,null===(t=n.sent())||void 0===t?void 0:t.token]}}))}))};if(!o&&""!==o)return Object(l.a)("3sEventsAPI: no substrate auth token. Aborting events API call"),void(null==i||i().then((function(t){t&&n.batchFlushInner(t)})));this.batchFlushInner(o)}},t.prototype.batchFlushInner=function(t){var e=this,n=this.getBatchToSend(),r=this.substrateHostName?0===this.substrateHostName.toLocaleLowerCase().indexOf("http://")||0===this.substrateHostName.toLocaleLowerCase().indexOf("https://")?this.substrateHostName:"https://".concat(this.substrateHostName):void 0;Object(c.a)(n,(function(n){var o="{0}/search/api/v1/events?scenario={1}".replace("{0}",r||"https://substrate.office.com").replace("{1}",n.scenario);Object(f.c)(o,t,JSON.stringify(n.body),e._xAnchorMailbox,e.locale,void 0,e.useNoBearerAuth),Object(l.a)("Event Logged to 3s Events API on Flush:\n",{scenario:n.scenario,batchToSend:n.ebatch,body:n.body},"\nTime: ",Math.floor(Date.now()))}))},t.prototype.formatEvent=function(t){return{Name:t.Name,Attributes:Object(v.a)(Object(g.a)(t.Attributes,(function(t,e){return!t&&0!==t||!e})),(function(t,e){return{Key:e,Value:null==t?void 0:t.toString()}}))}},t.prototype.logBatch=function(){var t,e;return Object(r.__awaiter)(this,void 0,void 0,(function(){var n,o,i,s,a=this;return Object(r.__generator)(this,(function(r){switch(r.label){case 0:return this._timerIsRunning=!1,Object(d.a)(this._batch)?[2]:this.isTokenValidationEnabled&&this._substrateTokenProvider?(o=null===(t=this._substrateTokenProvider)||void 0===t?void 0:t.getToken())||""===o?(n=o,[3,3]):[3,1]:[3,4];case 1:return[4,null===(e=this._substrateTokenProvider)||void 0===e?void 0:e.getTokenAsync().catch((function(t){a.logError("failed to get async token",t)}))];case 2:n=r.sent(),r.label=3;case 3:return[3,7];case 4:return(o=this.getToken())?(n=o,[3,7]):[3,5];case 5:return[4,this.refreshToken()];case 6:r.sent(),this._authToken&&(n=this._authToken.token),r.label=7;case 7:return n||""===n?(i=this.getBatchToSend(),s=n,Object(c.a)(i,(function(t){u((function(){var e;return Object(f.b)({action:"logevents",dataSource:"search-3s-logging",token:s,query:JSON.stringify(t.body),additionalInfo:(e={},e.scenario=t.scenario,e),anchorMailbox:a._xAnchorMailbox,locale:a.locale,logDiagnosticsMetrics:!1,substrateHostName:a.substrateHostName,useNoBearerAuth:a.useNoBearerAuth})})).then((function(e){var n;Object(l.a)("3sEventsAPI: batch logged successfully with TraceId:\n"+(null===(n=e.parsedBody)||void 0===n?void 0:n.Instrumentation.TraceId)+"\n",{scenario:t.scenario,batchToSend:t.ebatch,body:t.body},"\nTime: ",Math.floor(Date.now()))})).catch((function(e){var n,r,o,i;a.logError("call failure with TraceId: ".concat((null===(r=null===(n=e.parsedBody)||void 0===n?void 0:n.Instrumentation)||void 0===r?void 0:r.TraceId)||"",", Status: ").concat(e.statusCode||""),null===(i=null===(o=e.parsedBody)||void 0===o?void 0:o.error)||void 0===i?void 0:i.message,e.statusCode),a.mergeBack(t.scenario,t.ebatch,500!==e.statusCode)}))})),[2]):(this.logError("no substrate auth token. Aborting events API call"),[2])}}))}))},t.prototype.mergeBack=function(t,e,n){void 0===n&&(n=!0),!this._batch[t]||Object(d.a)(this._batch[t])?this._batch[t]=e:this._batch[t]=Object(b.a)(this._batch[t],e),!this._timerIsRunning&&this._retriesRemaining>0&&n&&(this.decrementRetryCounter(),this.startTimer())},t.prototype.addEvent=function(t,e,n,r){void 0===r&&(r=Object(s.a)()),this._batch[t]||(this._batch[t]={}),this._batch[t][e]||(this._batch[t][e]={}),this._batch[t][e][r]=n},t.prototype.resetRetryCounter=function(){this._retriesRemaining=4},t.prototype.decrementRetryCounter=function(){this._retriesRemaining--},t.prototype.startTimer=function(){var t=this;this._timerIsRunning=!0,this._logBatchAfterTimeout=setTimeout((function(){return t.logBatch()}),this._batchTimeout)},t.prototype.getBatchFromLocalStorage=function(t){var e=this;if(void 0===t&&(t=!0),this._localStorageAvailable){var n=localStorage.getItem("Search3sLoggingBeforeUnload");if(n&&n.length>0){var r=JSON.parse(n);2===r.LocalStorageVersion&&Object(c.a)(r.Batch,(function(n,r){e.mergeBack(r,n,t)}))}var o="";!t&&Object(a.a)(this._batch)<40&&(o=JSON.stringify(this.getBatchToSave())),localStorage.setItem("Search3sLoggingBeforeUnload",o)}},t.prototype.getBatchToSave=function(){return{LocalStorageVersion:2,Batch:this._batch}},t.prototype.getBatchToSend=function(){var t=this._batch;return this._batch={},Object(v.a)(t,(function(t,e){return{scenario:e,ebatch:t,body:Object(v.a)(t,(function(t,e){return{Key:e,Value:Object(v.a)(t,(function(t){return t}))}}))}}))},t.prototype.getToken=function(t){if(this._authToken&&this._authToken.tokenExpiry)return t&&0===this._authToken.tokenExpiry||this._authToken.tokenExpiry>(new Date).getTime()?this._authToken.token:void 0},t.prototype.refreshToken=function(){return Object(r.__awaiter)(this,void 0,void 0,(function(){var t,e=this;return Object(r.__generator)(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),this._authToken=void 0,[4,this._getAuthTokenAsync().then((function(t){return e._authToken=t,t}))];case 1:return[2,n.sent()];case 2:return t=n.sent(),this.logError("failure getting token",t),[2];case 3:return[2]}}))}))},t.prototype.logError=function(t,e,n){var r;void 0===t&&(t="An error occurred");var o="3sEventsAPI: ".concat(t);Object(l.b)(o,e),null===(r=this.log3sError)||void 0===r||r.call(this,o,n)},t}(),p=function(){function t(t,e,n,r,o,i,s,a,c,u,h){this._scenarioName=t,this._eventMapper=e,this._getAuthTokenAsync=n,this._getAuthToken=r,this._getRawAuthToken=o,this.isTokenValidationEnabled=i,this._xAnchorMailbox=s,this._batchTimeout=a,this.locale=c,this.substrateHostName=u,this.useNoBearerAuth=h,this._logManager=new T(this._scenarioName,this._getAuthTokenAsync,this._getAuthToken,this._getRawAuthToken,this.isTokenValidationEnabled,this._batchTimeout,this._xAnchorMailbox,c,u,h)}return t.prototype.canConsumeEvent=function(t){return!0},t.prototype.consume=function(t,e){var n=this._eventMapper(t);if(n){var r=this.getKey(n);this._logManager&&r&&this._logManager.logEvent(n,r,e)}},t.prototype.flush=function(){return this._logManager&&this._logManager.flush(),Promise.resolve()},t.prototype.destroy=function(){this.flush(),delete this._logManager},t.prototype.getLogManager=function(){return this._logManager},t.prototype.getKey=function(t){var e,n,r;switch(t.Name){case"CachedContentRendered":return null===(e=null==t?void 0:t.Attributes.NewLogicalId)||void 0===e?void 0:e.toString();case"SearchEntityActions":case"SearchActions":case"ClientDataSource":case"ClientLayout":case"ResultsRendered":case"SearchFeedback":case"CounterFactualInformation":return null===(n=null==t?void 0:t.Attributes.LogicalId)||void 0===n?void 0:n.toString();case"ResponseReceived":return null===(r=null==t?void 0:t.Attributes.TraceId)||void 0===r?void 0:r.toString();default:Object(i.a)(t.Name)}},t}();n("32I/");const m=["search-3s-logging","SubstrateWarmup_RoundTripTime"];function k(t){if(!function(t){const e=t;switch(e){case"MicrosoftSearchClickEvent":case"MicrosoftSearchClickEntityEvent":case"MicrosoftSearchClientDataSourceEvent":case"MicrosoftSearchClientLayoutEvent":case"MicrosoftSearchRoundTripTimeEvent":case"MicrosoftSearchResultsRenderedEvent":case"MicrosoftSearchCachedContentRenderedEvent":case"MicrosoftSearchFeedbackEvent":case"MicrosoftSearchCounterFactualInformationEvent":return!0;case"MicrosoftSearchClientDataSourceAriaEvent":case"MicrosoftSearchClickAriaEvent":case"MicrosoftSearchDiagnosticsEvent":case"MicrosoftSearchPerformanceEvent":case"MicrosoftSearchValidateEvent":case"MicrosoftSearchRoundTripTimeBundleEvent":case"MicrosoftSearchQueryEvent":case"MicrosoftSearchRankingEvent":case"MicrosoftSearchImpressionEvent":case"MicrosoftSearchAnswerResultsRenderedEvent":case"MicrosoftSearchSignInEvent":case"MicrosoftSearchSignOutEvent":case"MicrosoftSearchValueEvent":case"MicrosoftSearchQfValueEvent":case"MicrosoftSearchQfRankEvent":case"MicrosoftSearchResourcePerformanceEvent":case"MicrosoftSearchPerformanceTimingsEvent":case"MicrosoftSearchVariantEvent":case"MicrosoftSearchQfVariantEvent":case"MicrosoftSearchPrivacyEvent":case"MicrosoftSearchLatencyEvent":case"MicrosoftSearchMissingInstEvent":return!1;default:return Object(i.b)(e,!1)}}(t.featureName))return;const{properties:e}=t,n=e;let r;switch(t.source){case"ResponseReceived":r=-1===m.indexOf(t.eventId)?t.source:void 0;break;default:r=t.source}return function(t,e,n,r){if(t)return n?{name:t,properties:r?Object.assign(Object.assign({},e),{metadata:JSON.stringify(r)}):e}:{Name:t,Attributes:r?Object.assign(Object.assign({},e),{Metadata:JSON.stringify(r)}):e}}(r,n,!1)}var y,S=n("2npF");function E(t){var e=(t.getBufferedLogEvents&&t.getBufferedLogEvents()||t.logEventBuffer||[]).slice(),n=null;function i(){return Object(r.__awaiter)(this,void 0,void 0,(function(){var e;return Object(r.__generator)(this,(function(n){switch(n.label){case 0:return e={},[4,t.tokenProvider({attempt:0}).then((function(t){return t}))];case 1:return e.token=n.sent(),[2,e]}}))}))}var s,a=(s=t.logCtx.hostAppInfo,new p(s.id,k,i)),c=t.instrumenter;function u(e){var n=e;return"ClientDataSource"==n.name&&(n=function(e){var n=t.logCtx,o=n.userInfo,i=n.tenantInfo;return{name:"ClientDataSource",eventType:"USAGE",nameDetail:e.nameDetail,properties:Object(r.__assign)(Object(r.__assign)({},e.properties),{UserId:o.id,TenantId:i.omsId})}}(n)),Object(r.__assign)(Object(r.__assign)({},n),{featureName:h(n.name),eventId:n.nameDetail,source:n.name})}function h(t){switch(t){case"ResponseReceived":return"MicrosoftSearchRoundTripTimeEvent";case"ClientLayout":return"MicrosoftSearchClientLayoutEvent";case"ResultsRendered":return"MicrosoftSearchResultsRenderedEvent";case"ClientDataSource":return"MicrosoftSearchClientDataSourceEvent";case"SearchFeedback":return"MicrosoftSearchFeedbackEvent";case"SearchActions":return"MicrosoftSearchClickEvent";case"SearchEntityActions":return"MicrosoftSearchClickEntityEvent";case"CachedContentRendered":return"MicrosoftSearchCachedContentRenderedEvent";case"CounterFactualInformation":return"MicrosoftSearchCounterFactualInformationEvent";default:return t}}function l(t){a&&function(t){return("QOSSTOP"==t.eventType||"USAGE"==t.eventType)&&Object(S.e)(t.name)}(t)&&a.consume(u(t))}return c&&Object(o.a)(c,["hostAppInfo"],(function(){a&&(a.destroy(),a=new p(c.props.hostAppInfo.id,k,i))})),{enable:function(){e.forEach(l),e=[],null===n&&(n=t.dispatcher.register(l))},disable:function(){n&&(t.dispatcher.unregister(n),n=null)}}}function A(t){y||(y=E(Object(r.__assign)({},t))).enable()}}}]);