/*! For license information please see sp-pages-fluid_en-us_91deccfd2fde1aa45d98.js.LICENSE.txt */
define("5d035ed9-1466-4684-96ce-47c6b653dd01_0.1.0",["tslib","@microsoft/sp-http-base","@ms/office-ui-fabric-react-bundle","@microsoft/sp-loader","@microsoft/sp-lodash-subset","@microsoft/sp-core-library","@microsoft/sp-page-context","@ms/sp-edit-customer-promise","react","@ms/sp-component-utilities","@microsoft/load-themed-styles","@ms/sp-canvas-read","@microsoft/sp-diagnostics","@microsoft/sp-http","@ms/odsp-utilities-bundle"],function(n,a,i,r,o,s,c,d,l,u,f,p,m,_,h){return function(e){function t(t){for(var n,i,r=t[0],o=t[1],s=0,d=[];s<r.length;s++)i=r[s],Object.prototype.hasOwnProperty.call(a,i)&&a[i]&&d.push(a[i][0]),a[i]=0;for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n]);for(c&&c(t);d.length;)d.shift()()}var n={},a={1:0};function i(t){if(n[t])return n[t].exports;var a=n[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,i),a.l=!0,a.exports}i.e=function(e){var t=[],n=a[e];if(0!==n)if(n)t.push(n[2]);else{var r=new Promise(function(t,i){n=a[e]=[t,i]});t.push(n[2]=r);var o,s=document.createElement("script");s.charset="utf-8",s.timeout=120,i.nc&&s.setAttribute("nonce",i.nc),s.src=function(e){return i.p+"chunk."+({0:"sp-fluid-debug"}[e]||e)+"_"+"none"+"_"+{0:"b551a6af144925a153e7"}[e]+".js"}(e),0!==s.src.indexOf(window.location.origin+"/")&&(s.crossOrigin="anonymous");var c=new Error;o=function(t){s.onerror=s.onload=null,clearTimeout(d);var n=a[e];if(0!==n){if(n){var i=t&&("load"===t.type?"missing":t.type),r=t&&t.target&&t.target.src;c.message="Loading chunk "+e+" failed.\n("+i+": "+r+")",c.name="ChunkLoadError",c.type=i,c.request=r,n[1](c)}a[e]=void 0}};var d=setTimeout(function(){o({type:"timeout",target:s})},12e4);s.onerror=s.onload=o,document.head.appendChild(s)}return Promise.all(t)},i.m=e,i.c=n,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)i.d(n,a,function(t){return e[t]}.bind(null,a));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i.oe=function(e){throw console.error(e),e};var r=window.webpackJsonp_5d035ed9_1466_4684_96ce_47c6b653dd01_0_1_0=window.webpackJsonp_5d035ed9_1466_4684_96ce_47c6b653dd01_0_1_0||[],o=r.push.bind(r);r.push=t,r=r.slice();for(var s=0;s<r.length;s++)t(r[s]);var c=o;return function(){var e,t=document.getElementsByTagName("script"),n="undefined"!=typeof spScriptNamePattern?spScriptNamePattern:/sp\-pages\-fluid_en-us_91deccfd2fde1aa45d98\.js/i;if(t&&t.length)for(var a=0;a<t.length;a++)if(t[a]){var r=t[a].getAttribute("src");if(r&&r.match(n)){e=r.substring(0,r.lastIndexOf("/")+1);break}}if(!e)for(var o in window.__setWebpackPublicPathLoaderSrcRegistry__)if(o&&o.match(n)){e=o.substring(0,o.lastIndexOf("/")+1);break}i.p=e}(),i(i.s="mwqp")}({"17wl":function(e,t){e.exports=n},"1VJ6":function(e,t,n){"use strict";var a,i="object"==typeof Reflect?Reflect:null,r=i&&"function"==typeof i.apply?i.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};a=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function s(){s.init.call(this)}e.exports=s,e.exports.once=function(e,t){return new Promise(function(n,a){function i(n){e.removeListener(t,r),a(n)}function r(){"function"==typeof e.removeListener&&e.removeListener("error",i),n([].slice.call(arguments))}b(e,t,r,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&b(e,"error",t,{once:!0})}(e,i)})},s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var c=10;function d(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function l(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function u(e,t,n,a){var i,r,o,s;if(d(n),void 0===(r=e._events)?(r=e._events=Object.create(null),e._eventsCount=0):(void 0!==r.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),r=e._events),o=r[t]),void 0===o)o=r[t]=n,++e._eventsCount;else if("function"==typeof o?o=r[t]=a?[n,o]:[o,n]:a?o.unshift(n):o.push(n),(i=l(e))>0&&o.length>i&&!o.warned){o.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=o.length,s=c,console&&console.warn&&console.warn(s)}return e}function f(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(e,t,n){var a={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=f.bind(a);return i.listener=n,a.wrapFn=i,i}function m(e,t,n){var a=e._events;if(void 0===a)return[];var i=a[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):h(i,i.length)}function _(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function h(e,t){for(var n=new Array(t),a=0;a<t;++a)n[a]=e[a];return n}function b(e,t,n,a){if("function"==typeof e.on)a.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,function i(r){a.once&&e.removeEventListener(t,i),n(r)})}}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");c=e}}),s.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return l(this)},s.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var a="error"===e,i=this._events;if(void 0!==i)a=a&&void 0===i.error;else if(!a)return!1;if(a){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var s=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw s.context=o,s}var c=i[e];if(void 0===c)return!1;if("function"==typeof c)r(c,this,t);else{var d=c.length,l=h(c,d);for(n=0;n<d;++n)r(l[n],this,t)}return!0},s.prototype.addListener=function(e,t){return u(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return u(this,e,t,!0)},s.prototype.once=function(e,t){return d(t),this.on(e,p(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){return d(t),this.prependListener(e,p(this,e,t)),this},s.prototype.removeListener=function(e,t){var n,a,i,r,o;if(d(t),void 0===(a=this._events))return this;if(void 0===(n=a[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete a[e],a.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,r=n.length-1;r>=0;r--)if(n[r]===t||n[r].listener===t){o=n[r].listener,i=r;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(a[e]=n[0]),void 0!==a.removeListener&&this.emit("removeListener",e,o||t)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(e){var t,n,a;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,r=Object.keys(n);for(a=0;a<r.length;++a)"removeListener"!==(i=r[a])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(a=t.length-1;a>=0;a--)this.removeListener(e,t[a]);return this},s.prototype.listeners=function(e){return m(this,e,!0)},s.prototype.rawListeners=function(e){return m(this,e,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):_.call(e,t)},s.prototype.listenerCount=_,s.prototype.eventNames=function(){return this._eventsCount>0?a(this._events):[]}},"2SXB":function(e,t){e.exports=a},"5pbq":function(e,t){e.exports=i},EMNu:function(e){e.exports=JSON.parse('{"e":"Are you sure you want to leave this page?"}')},I6O9:function(e,t){e.exports=r},Pk8u:function(e,t){e.exports=o},UWqr:function(e,t){e.exports=s},"X+PM":function(e,t){e.exports=c},Z95U:function(e,t){e.exports=d},cDcd:function(e,t){e.exports=l},ffNP:function(e){e.exports=JSON.parse('{"c":"{0} other people have this page open","n":"is editing {0}","r":"has {0} selected","i":"has this page open","a":"is away","e":"a section","o":"text","s":"{0} web part","t":"Invite others"}')},"hiL/":function(e,t){e.exports=u},jOlS:function(e,t){e.exports=f},mwqp:function(e,t,n){"use strict";n.r(t),n.d(t,"MetadataKeys",function(){return Me}),n.d(t,"canDebugFluid",function(){return M}),n.d(t,"PageFluidOrchestrator",function(){return Mn}),n.d(t,"isCoAuthLifeCycleError",function(){return hn}),n.d(t,"CanvasPresence",function(){return rt}),n.d(t,"CommandBarPresence",function(){return Kt}),n.d(t,"arePresencesUpdated",function(){return Ne}),n.d(t,"getSortedPresencesByJoinTime",function(){return Be}),n.d(t,"useHighlightAnimation",function(){return tt}),n.d(t,"useIsEditing",function(){return Ye}),n.d(t,"useRemotePresences",function(){return Jt}),n.d(t,"PresenceManager",function(){return Yt}),n.d(t,"isPresenceRte",function(){return kt}),n.d(t,"isPresenceWebPart",function(){return Mt}),n.d(t,"isPresenceZone",function(){return Pt}),n.d(t,"isPresenceControl",function(){return Tt}),n.d(t,"isPresenceActive",function(){return Ut}),n.d(t,"isPresenceInactive",function(){return Ft}),n.d(t,"isPresenceScrollable",function(){return Ht}),n.d(t,"comparePresences",function(){return Rt});var a=n("ut3N"),i=n("hiL/"),r=n("1VJ6"),o=n("Pk8u");const s=a._LogSource.create("UndoRedoStackManager");var c;!function(e){e.None="None",e.Redo="Redo",e.Undo="Undo",e.UndoIntermediate="UndoIntermediate",e.RedoIntermediate="RedoIntermediate"}(c||(c={}));class d{constructor(...e){this._items=[],void 0!==e&&e.forEach(e=>this.push(e))}get isEmpty(){return 0===this._items.length}top(){if(!this.isEmpty)return this._items[0]}pop(){return this._items.shift()}push(e){this._items.unshift(e),void 0!==this.itemPushedCallback&&this.itemPushedCallback()}_toArray(){return Object(o.cloneDeep)(this._items)}}class l{constructor(e){this._operation=e}get preState(){return this._operation.preState}get postState(){return this._operation.postState}set postState(e){this._operation.postState=e}get revertibleStack(){return this._operation.revertibleStack}get isEmpty(){return this._operation.revertibleStack.isEmpty}}class u extends d{push(e){void 0!==e&&(e.revertibleStack.itemPushedCallback=this.itemPushedCallback),super.push(e)}closeCurrentOperationIfInProgress(e){const t=this.top();t&&(t.postState=e,this.push(void 0))}}class f{constructor(){this._undoStack=new u,this._redoStack=new u,this._mode=c.None,this._eventEmitter=new r.EventEmitter,this.closeCurrentOperation=e=>{this._mode===c.None&&(this._undoStack.closeCurrentOperationIfInProgress(e),this.state=e)},this.on=(e,t)=>(this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)),this.undoOperation=()=>{if(this._undoStack.isEmpty)return!1;try{return this._mode=c.Undo,this._revert(this._undoStack,this._redoStack),this._mode=c.None,!0}catch(e){return this._clearStackAndLogError("UndoFailure",e),!1}},this.redoOperation=()=>{if(this._redoStack.isEmpty)return!1;try{return this._mode=c.Redo,this._revert(this._redoStack,this._undoStack),this._mode=c.None,!0}catch(e){return this._clearStackAndLogError("RedoFailure",e),!1}},this.pushToCurrentOperation=e=>{var t;let n;switch(this._mode){case c.None:n=this._undoStack,this._clearStack(this._redoStack);break;case c.Redo:case c.RedoIntermediate:n=this._undoStack;break;case c.Undo:case c.UndoIntermediate:n=this._redoStack;break;default:throw new Error("unknown mode")}const a=null===(t=n.top())||void 0===t?void 0:t.revertibleStack;if(a)a.push(e);else{const t=new l({preState:this._latestState,revertibleStack:new d(e),postState:void 0});n.push(t)}},this.isUndoStackEmpty=()=>this._undoStack.isEmpty,this.isRedoStackEmpty=()=>this._redoStack.isEmpty,this._clearStack=e=>{for(var t;!e.isEmpty;){const n=null===(t=e.pop())||void 0===t?void 0:t.revertibleStack;if(n)for(;!n.isEmpty;){const e=n.pop();e&&e.discard()}}},this._clearStackAndLogError=(e,t)=>{new a._QosMonitor("CoAuth.UndoRedoStackManagerError").writeUnexpectedFailure(e,t,{undoStack:JSON.stringify(this._undoStack._toArray()),redoStack:JSON.stringify(this._redoStack._toArray())}),a._TraceLogger.logError(s,t),this._clearStack(this._undoStack),this._clearStack(this._redoStack)},this._undoStack.itemPushedCallback=()=>{this._eventEmitter.emit("changePushed")},this._redoStack.itemPushedCallback=()=>{this._eventEmitter.emit("changePushed")}}get state(){return this._mode===c.None?this._latestState:this._nextStateAfterUndoRedo}set state(e){if(this._latestState=e,this._mode===c.None){const t=this._undoStack.top();t&&(t.postState=e)}}get mode(){return this._mode}get _TEST_EXPORT(){return{undoStack:this._undoStack,redoStack:this._redoStack}}_revert(e,t){t.closeCurrentOperationIfInProgress(void 0);let n=e.pop();for(;!e.isEmpty&&(void 0===n||n.isEmpty);)n=e.pop();if(!n)return;const a=this._mode;for(this._nextStateAfterUndoRedo=a===c.Undo?n.preState:n.postState,this._latestState=n.preState;!n.isEmpty;){const e=n.revertibleStack.pop();this._mode=n.isEmpty?a:a===c.Undo?c.UndoIntermediate:c.RedoIntermediate,null==e||e.revert()}e.closeCurrentOperationIfInProgress(void 0),t.closeCurrentOperationIfInProgress(n.postState),this._latestState=this._nextStateAfterUndoRedo}}class p{constructor(e){this._undoRedoStackManager=e,this.isDisposed=!1,this._eventEmitter=new r.EventEmitter,this._latestStackStatus={canUndo:!1,canRedo:!1},this.on=(e,t)=>(this._eventEmitter.on(e,t),()=>this._eventEmitter.removeListener(e,t)),this.undo=()=>this._undoRedoStackManager.undoOperation(),this.redo=()=>this._undoRedoStackManager.redoOperation(),this.canUndo=()=>!this._undoRedoStackManager.isUndoStackEmpty(),this.canRedo=()=>!this._undoRedoStackManager.isRedoStackEmpty(),this._checkStackStatusAndNotifyChanges=()=>{const e={canUndo:this.canUndo(),canRedo:this.canRedo()};Object(o.isEqual)(this._latestStackStatus,e)||(this._latestStackStatus=e,this._eventEmitter.emit("statusChanged",e))},this._unsubscriber=this._undoRedoStackManager.on("changePushed",this._checkStackStatusAndNotifyChanges)}dispose(){this.isDisposed=!0,this._eventEmitter.removeAllListeners(),this._unsubscriber()}}var m=n("UWqr"),_=n("sSDQ");class h{}h.documentRoot="7fc094ae-d517-4ee0-a87f-2a5f0ff2880b",h.lockedWebPartsRoot="e1b79100-01cc-4c08-8dd2-d647b55969aa",h.canvasRoot="46d25967-4a02-4526-9e91-70de0a4a36f9",h.layout="7106fb6a-bf5d-471e-b160-b275fbbf522f",h.layoutIndex="e1847afb-dcc1-402a-b222-f95ece8318ce",h.layoutIsReflowOnTop="6aca3f9c-0454-48e6-a729-b07ce4ebdc67",h.zone="54e41ee9-c698-4735-9f5e-c31125ce4ecc",h.zoneEmphasis="dada1259-221f-4e0b-bde0-7ead46802871",h.zoneGroupMetadata="60d4ff4f-461d-4c67-9696-de1136740dcd",h.zoneId="7ab86d5c-d385-4559-9b78-06275d0f4883",h.zoneAudiences="57a6746c-2724-47ad-8a3e-7598d5d14975",h.section="ca5749e1-0dc8-4686-a507-e837db9d6622",h.sectionFactor="86eb41e8-2d72-4571-9834-da014f6eb413",h.control="2d657b56-ac46-43fe-8a5f-be811423d1eb",h.controlId="b0339148-208a-4c7c-a706-e19daa31b44f",h.isControlFromSectionTemplate="3cd79a1f-3435-4026-bf86-f181a6dc0abb",h.isControlAddedFromPersistedData="3f4a0217-8463-49be-99be-410d970ec160",h.controlType="a34591fc-9f52-4586-97f8-291b027d53c1",h.innerHTML="1075c785-7f43-4bc9-9fcd-00cbe4b04cb4",h.contentVersion="9d4cea82-c343-4fe3-b25f-ae5a9739a6bc",h.webPartReservedSize="41dcc0bd-1365-4f98-96c5-43f2396a5eb5",h.webPartId="de436f8b-45ff-487c-825e-92183461d7f0",h.webPartData="6ba3fc8c-b092-47b4-a25b-532b67ef0e01",h.rteInstanceId="a966a2bb-94ba-4a13-b330-76ef1aab3ffa",h.lockedWebPart="641de0f0-8661-4bc8-b7a7-bbb72932e317",h.lockedWebPartData="ed10fc96-2b72-4623-b4a7-4d8024e535b5",h.lockedWebPartInstanceId="4ddb0104-d219-4211-a250-b44f6f04a852",h.lockedWebPartReservedSize="006740c3-363a-466b-ab36-70fba0115cc6";class b{}b.documentRoot="242ef280-23d9-4698-9029-27441d0f537d",b.canvasRoot="26227927-a6fa-43b7-b18f-b9917b34cf79",b.lockedWebPartsRoot="2a9566ab-75b3-4ac2-b297-2c6c9e0db281",b.layouts="3d8bf0ae-8972-4392-8f32-6b1af49dcd24",b.layoutIndex="dd078a99-095b-4dd6-9b30-ebf9da4ef9f0",b.layoutIsReflowOnTop="118377b4-167c-4eb1-a6ce-a3ef19f232f4",b.zones="c7777f12-a169-468b-88c4-5e14c28e1eca",b.zoneEmphasis="73d0d249-12ea-4549-9da6-7967518d7cd0",b.zoneGroupMetadata="7ebad8a8-4aef-4732-a61c-74cc2729b1c0",b.zoneId="1a34ce4c-0fbb-423d-9f8e-eeaba9603573",b.zoneAudiences="ba757abc-d097-4c60-b906-74ff92323a70",b.sections="09d628bd-baaf-48da-a3a9-e057d4d7ea1f",b.sectionFactor="0ceb44af-5c74-4a67-a355-8d9de90ea63a",b.controls="f4b092b1-99d8-4f9f-af2d-630117dd7718",b.controlId="91fbd073-1e66-4bbb-a801-64b0f1530121",b.isControlFromSectionTemplate="de7505eb-0693-4cfc-84d0-04288c94ca70",b.isControlAddedFromPersistedData="391b2c8b-712a-4f2f-9245-1525d695adbc",b.controlType="1df01c69-7cb3-4624-bbc5-ce145d31f68e",b.innerHTML="4511ba43-de95-463c-8a3c-6923acdbe00e",b.contentVersion="c7bcb64d-28d8-47be-971b-09906e81b75b",b.inlineControls="42db5a82-b24f-4e8f-9e24-dd53216d4c89",b.webPartReservedSize="c0712b3a-d5e3-4140-b258-e04ff3db785d",b.webPartId="271fe664-3e83-4782-b6f6-a109ef983639",b.webPartData="f9059705-5cd3-403e-94e7-54a4bdf67d24",b.rteInstanceId="7a40eb46-b5b8-44f1-a86d-4e4b1cf899bc",b.lockedWebParts="571aaa8e-a7d1-4f70-90a1-c8206112b12c",b.lockedWebPartData="9513d38b-ae6c-4769-b7e2-c4035a269df9",b.lockedWebPartInstanceId="401953e7-555b-45b3-9695-94b8fafaed81",b.lockedWebPartReservedSize="729e4107-b9a1-4102-b713-2ba7639581da";const g="emptySection";var v=n("17wl");function y(e,t,n){const a=I(e,t,n);return w(a,"Cannot find the layout node."),a}function S(e,t,n){const{zoneOrder:a,layoutIndex:i}=n,r=x(e,y(e,t,i),a);return w(r,"Cannot find the zone node."),r}function D(e,t,n){const{sectionOrder:a}=n,i=C(e,S(e,t,Object(v.__rest)(n,["sectionOrder"])),a);return w(i,"Cannot find the section node."),i}function I(e,t,n){return function(e,t,n){if(!t)return"AtStart";const a=t.map(function(t){const n=e.getViewNode(t).traits.get(b.layoutIndex)[0];return e.getViewNode(n).payload||0});if(!a||!a.length||n<a[0])return"AtStart";if(n>a[a.length-1])return"AtEnd";{const i=a.indexOf(n);return e.getViewNode(t[i])}}(e,t.traits.get(b.layouts),n)}function x(e,t,n){return L(e,t.traits.get(b.zones),n)}function C(e,t,n){return L(e,t.traits.get(b.sections),n)}function O(e,t,n){return L(e,t.traits.get(b.controls),n)}function w(e,t){if("string"==typeof e)throw new Error(`Message: ${t}`)}function E(e){const t=A(e).traits.get(b.canvasRoot);if(null==t?void 0:t.length)return e.getViewNode(t[0]);throw new Error("Cannot find Canvas root node. The tree data structure is compromised")}function A(e){const t=e.root,n=e.getViewNode(t).traits.get(b.documentRoot);if(null==n?void 0:n.length)return e.getViewNode(n[0]);throw new Error("Canvas find document root node. The tree data structure is compromised")}function L(e,t,n){return!t||!t.length||n<0?"AtStart":n>=t.length?"AtEnd":e.getViewNode(t[n])}class k{constructor(){this._nodeIdToUniqueId={},this._uniqueIdToNodeId={},this._entries=[],this._fromNodeIdToUniqueId=e=>this._nodeIdToUniqueId[e],this._fromUniqueIdToNodeId=e=>this._uniqueIdToNodeId[e]}add(e){this._entries.push(e);const{nodeId:t,uniqueId:n}=e;this._nodeIdToUniqueId[t]=n,this._uniqueIdToNodeId[n]=t}getMap(){return{fromNodeIdToUniqueId:this._fromNodeIdToUniqueId,fromUniqueIdToNodeId:this._fromUniqueIdToNodeId,_getLogForTelemetry:()=>JSON.stringify(this._entries)}}}function M(){return m._SPFlight.isEnabled(466)||m._SPFlight.isEnabled(1310)}function P(e,t){throw new a._QosMonitor("CoAuth.DataCorruptedError").writeUnexpectedFailure(e,t),a._TraceLogger.logError(a._LogSource.create(e),t),t}class T{constructor(){this.isDisposed=!1,this._logs=[],this._callbacksMap=new Map,this._handleKeyDown=e=>{"f"!==e.key&&"F"!==e.key||!e.shiftKey||!e.ctrlKey&&!e.metaKey||!e.altKey||this.isDisposed||this._generateLogFileAndDownload()},this._finalizeLogs=(e=!1)=>{const t=[];return this._callbacksMap.forEach((n,a)=>{try{t.push(""),t.push(`Extra logs for "${a}":`),t.push(...n(!e))}catch(e){t.push(`Failed when printing extra logs for '${a}': `),t.push(String(e))}}),[...this._logs,...t].join("\n")},this._generateLogFileAndDownload=()=>{const e=document.createElement("a");e.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(this._finalizeLogs())),e.setAttribute("download","DiagnosticLogs_Fluid"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)},document.addEventListener("keydown",this._handleKeyDown),this._unsubcribeCustomContextDataHandler=function(e,t,n){const a="Pages CoAuth_CustomContextData",i=e=>{e.detail.addLogs("Authoring Diagnostic.txt",n(e.detail.isSPDF))};return document.addEventListener(a,i),()=>document.removeEventListener(a,i)}(0,0,this._finalizeLogs)}static get instance(){return T._instance||(T._instance=new T)}static dispose(){T._instance&&(T._instance.dispose(),delete T._instance)}addLog(e){this.isDisposed||this._logs.push(e)}addCallbackForExtraLogs(e,t){this._callbacksMap.set(e,t)}dispose(){document.removeEventListener("keydown",this._handleKeyDown),this._unsubcribeCustomContextDataHandler(),this.isDisposed=!0}}class U{constructor(){this._isDisposed=!1,this._extraLogs=[];const e=HTMLElement.prototype.focus;this._oldHTMLFocus=e;const t=this._extraLogs;HTMLElement.prototype.focus=function(n){const a=U._findNearestAncestorWebPart(document.activeElement),i=U._findNearestAncestorWebPart(this);if(i&&!i.isSameNode(a)){const e=`Focus moved programatically at ${new Date}: `+Error().stack;t.push(e)}e.apply(this,[n])},T.instance.addCallbackForExtraLogs("Events that programatically moved focus",()=>this._extraLogs)}get isDisposed(){return this._isDisposed}dispose(){HTMLElement.prototype.focus=this._oldHTMLFocus,this._extraLogs.length=0,this._isDisposed=!0}}U._findNearestAncestorWebPart=e=>e?e.closest('[data-sp-web-part-id], [data-sp-feature-tag="Rich Text Editor"]'):null;var F,H=n("rAxy");function R(e,t,n){var a;const i=null===(a=t.traits.get(n))||void 0===a?void 0:a[0];return i?e.getViewNode(i).payload:void 0}function N(e,t,n){const a=R(e,t,n);return void 0===a&&P("CannotRetrieveTrait",new Error("SharedTree is corrupted. Cannot retrieve trait: "+n.toString())),a}function B(e,t,n,a){var i;const r=t.traits.get(n);if(!r||!r.length)return;const s=null===(i=e.getViewNode(r[0]))||void 0===i?void 0:i.payload;return Object(o.isEqual)(s,a)?void 0:Object(H.e)().Change.setPayload(r[0],a)}function j(e,t,n,a,i){const r=t.traits.get(n);if(!r||!r.length)return[];const s=e.getViewNode(r[0]),c=null==s?void 0:s.payload;return Object(o.isEqual)(c,a)?[]:[Object(H.e)().Change.delete(Object(H.e)().StableRange.only(s.identifier)),...Object(H.e)().Change.insertTree(i,Object(H.e)().StablePlace.atStartOf({parent:t.identifier,label:n}))]}function V(e){const t=e.filter(e=>!Object(_.isInlineWebPart)(e)),n=e.filter(_.isInlineWebPart);return{traits:{[b.layouts]:z(t,n)},definition:h.canvasRoot}}function z(e,t){const n=Object(_.groupControls)(e,e=>e.position.layoutIndex||1);let a=[];return n.length&&2!==n[0][0].position.layoutIndex||a.push({traits:{[b.layoutIndex]:[{definition:h.layoutIndex,payload:1,traits:{}}],[b.zones]:[]},definition:h.layout}),a=a.concat(n.map(e=>G(e,t))),a}function G(e,t){return{traits:{[b.layoutIndex]:[{definition:h.layoutIndex,payload:e[0].position.layoutIndex||1,traits:{}}],[b.zones]:K(e,t),[b.layoutIsReflowOnTop]:[{definition:h.layoutIsReflowOnTop,payload:e[0].position.isLayoutReflowOnTop,traits:{}}]},definition:h.layout}}function K(e,t){const n=Object(_.groupControls)(e,e=>e.position.zoneIndex),a=new Set;return n.map(e=>W(e,t,a))}function W(e,t,n){var a;const i=(null===(a=e[0].emphasis)||void 0===a?void 0:a.zoneEmphasis)||0,r=e[0].zoneGroupMetadata,o=e[0].zoneAudiences,s=e[0].position.zoneId,c=!s||(null==n?void 0:n.has(s))?m.Guid.newGuid().toString():s;return null==n||n.add(c),{traits:{[b.zoneId]:[{definition:h.zoneId,payload:c,traits:{}}],[b.zoneEmphasis]:[{definition:h.zoneEmphasis,payload:i,traits:{}}],[b.zoneGroupMetadata]:[{definition:h.zoneGroupMetadata,payload:r,traits:{}}],[b.zoneAudiences]:[{definition:h.zoneAudiences,payload:o,traits:{}}],[b.sections]:q(e,t)},definition:h.zone}}function q(e,t){return Object(_.groupControls)(e,e=>e.position.sectionIndex||0).map(e=>Q(e,t,void 0===e[0].position.sectionFactor?12:e[0].position.sectionFactor))}function Q(e,t,n){return{traits:{[b.controls]:e.filter(_.isWebPartOrRte).map(e=>Y(e,t)),[b.sectionFactor]:[{definition:h.sectionFactor,payload:n,traits:{}}]},definition:h.section}}function Y(e,t){const n=t.filter(t=>t.rteInstanceId===e.id);return{definition:h.control,traits:Object.assign({[b.controlId]:[{definition:h.controlId,traits:{},payload:e.id}],[b.controlType]:[{definition:h.controlType,traits:{},payload:e.controlType}],[b.isControlAddedFromPersistedData]:[{definition:h.isControlAddedFromPersistedData,traits:{},payload:e.addedFromPersistedData}],[b.isControlFromSectionTemplate]:[{definition:h.isControlFromSectionTemplate,traits:{},payload:e.isFromSectionTemplate}]},Object(_.isRte)(e)?J(e,n):X(e))}}function J(e,t){return{[b.innerHTML]:[$(e.innerHTML)],[b.contentVersion]:[{definition:h.contentVersion,traits:{},payload:e.contentVersion}],[b.inlineControls]:t.map(e=>Y(e,[]))}}function X(e){return{[b.webPartReservedSize]:[{definition:h.webPartReservedSize,traits:{},payload:{reservedWidth:e.reservedWidth,reservedHeight:e.reservedHeight}}],[b.webPartId]:[{definition:h.webPartId,traits:{},payload:e.webPartId}],[b.webPartData]:[Z(e.webPartData)]}}function Z(e){return{definition:h.webPartData,traits:{},payload:e}}function $(e){return{definition:h.innerHTML,traits:{},payload:e}}function ee(e,t,n=new Map){return ne(e,t,n),te(e,t,n)}function te(e,t,n){const a=e.getViewNode(t),i={};a.traits.forEach((t,a)=>{i[a]=t.map(t=>te(e,t,n))});const{definition:r,payload:s}=a;let c=Object(o.cloneDeep)(s);switch(r){case h.controlId:case h.zoneId:case h.rteInstanceId:c=n.get(c);break;case h.webPartData:if(c.instanceId=n.get(c.instanceId),s.instanceId&&!c.instanceId)throw new Error("Id replacement is missing for the cloned control.");break;case h.innerHTML:n.forEach((e,t)=>{c=c.replace(t,e)})}if(s&&!c)throw new Error("Id replacement is missing for the cloned control.");return{definition:a.definition,payload:c,traits:i}}function ne(e,t,n){const a=e.getViewNode(t);a.traits.forEach(t=>{t.forEach(t=>ne(e,t,n))});const{definition:i,payload:r}=a;i!==h.controlId&&i!==h.zoneId||n.has(r)||n.set(r,m.Guid.newGuid().toString())}function ae(){return m._SPKillSwitch.isActivated("568d129e-258e-4f80-8a89-c7dbe60f32a8")}function ie(){return m._SPKillSwitch.isActivated("90e3d8cf-8d7a-4857-9b9d-3f352a0e5277")}function re(){return m._SPKillSwitch.isActivated("59dd7256-3d49-4438-8404-502caa5a4941")}function oe(){return m._SPKillSwitch.isActivated("d47dc334-323a-4393-9150-67cf93f5d295")}function se(){return m._SPKillSwitch.isActivated("71c63bb6-964e-455d-9d1d-0a25a67e892b")}class ce{constructor(e){this._view=e}updateRte(e,t){if(!m._SPKillSwitch.isActivated("bdeb5a1e-ee9b-4841-a37d-ddce602dc53f")&&!Object(i.isDefined)(t.innerHTML))throw new Error("RTE innerHTML MUST be defined");const n=this._view.getViewNode(e);return[...ie()?[B(this._view,n,b.innerHTML,t.innerHTML)]:j(this._view,n,b.innerHTML,t.innerHTML,$(t.innerHTML)),B(this._view,n,b.contentVersion,t.contentVersion)].filter(i.isDefined)}addControlByOrders(e,t,n=!1){const{controlOrder:a,sectionOrder:i,zoneOrder:r,layoutIndex:s}=e,c=Object(o.cloneDeep)(t),d=this._canvasRootViewNode,l=I(this._view,d,s);if(n||w(l),"string"==typeof l){const e=G([c],[]);return Object(H.e)().Change.insertTree(e,"AtStart"===l?Object(H.e)().StablePlace.atStartOf({parent:d.identifier,label:b.layouts}):Object(H.e)().StablePlace.atEndOf({parent:d.identifier,label:b.layouts}))}const u=x(this._view,l,r);if(n||w(u),"string"==typeof u){const e=W([c],[]);return Object(H.e)().Change.insertTree(e,"AtStart"===u?Object(H.e)().StablePlace.atStartOf({parent:l.identifier,label:b.zones}):Object(H.e)().StablePlace.atEndOf({parent:l.identifier,label:b.zones}))}const f=C(this._view,u,i);if(n||w(f),"string"==typeof f){const e=Q([c],[],void 0===c.position.sectionFactor?12:c.position.sectionFactor);return Object(H.e)().Change.insertTree(e,"AtStart"===f?Object(H.e)().StablePlace.atStartOf({parent:u.identifier,label:b.sections}):Object(H.e)().StablePlace.atEndOf({parent:u.identifier,label:b.sections}))}if(!Object(_.isWebPartOrRte)(c))return[];const p=Y(c,[]),m=f.traits.get(b.controls);return 0!==a&&m&&0!==m.length?Object(H.e)().Change.insertTree(p,Object(H.e)().StablePlace.after(m[Math.min(a,m.length)-1])):Object(H.e)().Change.insertTree(p,Object(H.e)().StablePlace.atStartOf({parent:f.identifier,label:b.controls}))}addInlineControl(e,t){const n=this._view.getViewNode(e);w(n);const a=Y(t,[]);return Object(H.e)().Change.insertTree(a,Object(H.e)().StablePlace.atStartOf({parent:n.identifier,label:b.inlineControls}))}updateWebPart(e,t){const n=this._view.getViewNode(e);return[...ie()?[B(this._view,n,b.webPartData,t.webPartData)]:j(this._view,n,b.webPartData,t.webPartData,Z(t.webPartData)),B(this._view,n,b.isControlAddedFromPersistedData,t.addedFromPersistedData),B(this._view,n,b.isControlFromSectionTemplate,t.isFromSectionTemplate),B(this._view,n,b.rteInstanceId,t.rteInstanceId),B(this._view,n,b.webPartReservedSize,{reservedWidth:t.reservedWidth,reservedHeight:t.reservedHeight})].filter(e=>void 0!==e)}addZone(e,t){const{zoneOrder:n,layoutIndex:a}=e,i=this._canvasRootViewNode,r=I(this._view,i,a);if("string"==typeof r){const e=G(t,[]);return Object(H.e)().Change.insertTree(e,"AtStart"===r?Object(H.e)().StablePlace.atStartOf({parent:i.identifier,label:b.layouts}):Object(H.e)().StablePlace.atEndOf({parent:i.identifier,label:b.layouts}))}const o=t.filter(e=>!Object(_.isInlineWebPart)(e)),s=t.filter(_.isInlineWebPart);if(!Object(_.isNonEmptyArray)(o))throw new Error("Adding a zone without a control is not allowed!");const c=W(o,s),d=r.traits.get(b.zones);return!d||!d.length||n<=0?Object(H.e)().Change.insertTree(c,Object(H.e)().StablePlace.atStartOf({parent:r.identifier,label:b.zones})):n>=d.length?Object(H.e)().Change.insertTree([c],Object(H.e)().StablePlace.atEndOf({parent:r.identifier,label:b.zones})):Object(H.e)().Change.insertTree(c,Object(H.e)().StablePlace.before(d[n]))}moveZoneInFirstLayout(e,t){const n=this._canvasRootViewNode,a=y(this._view,n,1),i=x(this._view,a,e);w(i);const r=x(this._view,a,t);return"AtStart"===r?Object(H.e)().Change.move(Object(H.e)().StableRange.only(i),Object(H.e)().StablePlace.atStartOf({parent:a.identifier,label:b.zones})):"AtEnd"===r?Object(H.e)().Change.move(Object(H.e)().StableRange.only(i),Object(H.e)().StablePlace.atEndOf({parent:a.identifier,label:b.zones})):Object(H.e)().Change.move(Object(H.e)().StableRange.only(i),Object(H.e)().StablePlace.before(r.identifier))}ensureSection(e){return this.addControlByOrders(Object.assign(Object.assign({},e),{controlOrder:0}),{controlType:void 0,id:g,position:{layoutIndex:e.layoutIndex,zoneIndex:e.zoneOrder+1,sectionIndex:e.sectionOrder+1,controlIndex:1}},!0)}moveControl(e,t){const n=this._canvasRootViewNode,{controlOrder:a}=t,i=Object(v.__rest)(t,["controlOrder"]),r=function(e,t,n){const{controlOrder:a}=n,i=O(e,D(e,t,Object(v.__rest)(n,["controlOrder"])),a);return w(i,"Cannot find the control node."),i}(this._view,n,e);let o;try{o=D(this._view,n,i);const e=O(this._view,o,a);return Object(H.e)().Change.move(Object(H.e)().StableRange.only(r),"AtStart"===e?Object(H.e)().StablePlace.atStartOf({parent:o.identifier,label:b.controls}):"AtEnd"===e?Object(H.e)().StablePlace.atEndOf({parent:o.identifier,label:b.controls}):Object(H.e)().StablePlace.before(e.identifier))}catch(e){throw new Error('Cannot get target section node. Make sure target section exists before calling "moveControl"')}}cloneZone(e,t){const n=this._canvasRootViewNode,a=S(this._view,n,e),i=ee(this._view,a.identifier,t);return Object(H.e)().Change.insertTree(i,Object(H.e)().StablePlace.after(a.identifier))}cloneControl(e,t){const n=this._view.getViewNode(e),a=ee(this._view,n.identifier,t);return Object(H.e)().Change.insertTree(a,Object(H.e)().StablePlace.after(n.identifier))}deleteZone(e){const t=this._canvasRootViewNode,n=S(this._view,t,e);return[Object(H.e)().Change.delete(Object(H.e)().StableRange.only(n))]}deleteControls(e){return e.length?1===e.length?[this._deleteControl(e[0])]:e.map(e=>Object(H.e)().Change.delete(Object(H.e)().StableRange.only(e))):[]}updateZoneEmphasis(e,t){const n=this._canvasRootViewNode,a=S(this._view,n,e),i=B(this._view,a,b.zoneEmphasis,t);return i?[i]:[]}updateZoneAudiences(e,t){const n=this._canvasRootViewNode,a=S(this._view,n,e),i=B(this._view,a,b.zoneAudiences,t);return i?[i]:[]}updateLayoutIsReflowOnTop(e,t){const n=this._canvasRootViewNode,a=y(this._view,n,e),i=B(this._view,a,b.layoutIsReflowOnTop,t);return i?[i]:[]}updateZoneGroupMetadata(e,t){const n=this._canvasRootViewNode,a=S(this._view,n,e),i=B(this._view,a,b.zoneGroupMetadata,t);return i?[i]:[]}updateZoneSectionFactors(e,t){if(!t.length||t.length>3)throw new Error("Canvas zone can only have up to 3 canvas sections");const n=this._canvasRootViewNode,a=S(this._view,n,e),i=a.traits.get(b.sections),r=[];if(i||P("ZoneHasNoSection",new Error("Zone has no section. Data is corrupted.")),t.forEach((e,t)=>{const n=i[t];if(n){const t=this._view.getViewNode(n).traits.get(b.sectionFactor);t||P("NotSectionFactorTrait",new Error("Section factor trait not found. Data is corrupted."));const a=t[0];r.push(Object(H.e)().Change.setPayload(a,e))}else{const t=Q([],[],e);r.push(...Object(H.e)().Change.insertTree(t,Object(H.e)().StablePlace.atEndOf({parent:a.identifier,label:b.sections})))}}),i.length>t.length){const e=i[t.length-1];i.forEach((n,a)=>{if(a>=t.length){const t=this._view.getViewNode(n),a=t.traits.get(b.controls);a&&a.forEach(t=>{r.push(...Object(H.e)().Change.move(Object(H.e)().StableRange.only(t),Object(H.e)().StablePlace.atEndOf({parent:e,label:b.controls})))}),r.push(Object(H.e)().Change.delete(Object(H.e)().StableRange.only(t.identifier)))}})}return r}_deleteControl(e){return Object(H.e)().Change.delete(Object(H.e)().StableRange.only(e))}get _canvasRootViewNode(){return E(this._view)}}function de(e){return new fe(e).getCanvasContent()}!function(e){e[e.None=0]="None",e[e.Neutral=1]="Neutral",e[e.Soft=2]="Soft",e[e.Strong=3]="Strong"}(F||(F={}));const le=a._LogSource.create("CanvasContentBuilder");function ue(e,t){return Object(o.merge)({},e,t)}class fe{constructor(e){this._view=e,this._idMapGenerator=new k,this.getCanvasContent=()=>({canvasContent:this._composeCanvasContent(),idMap:this._idMapGenerator.getMap()}),this._composeCanvasContent=()=>{const e=E(this._view);try{const t=e.traits.get(b.layouts);return t?t.reduce((e,t,n)=>e.concat(this._composeFromLayout(t,{position:{layoutIndex:n+1}})),[]):[]}catch(e){throw a._TraceLogger.logError(le,e),e}},this._composeFromLayout=(e,t)=>{const n=this._view.getViewNode(e),a=n.traits.get(b.zones),i=R(this._view,n,b.layoutIsReflowOnTop);return a?a.reduce((e,n,a)=>{const r=ue(t,{position:{zoneIndex:a+1,isLayoutReflowOnTop:i}});return e.concat(this._composeFromZone(n,r))},[]):[]},this._composeFromZone=(e,t)=>{const n=this._view.getViewNode(e),a=n.traits.get(b.sections),i=R(this._view,n,b.zoneEmphasis)||F.None,r=R(this._view,n,b.zoneGroupMetadata),o=R(this._view,n,b.zoneAudiences),s=N(this._view,n,b.zoneId);return this._idMapGenerator.add({nodeId:e,uniqueId:s}),a?a.reduce((e,n,a)=>{const c=ue(t,{position:{zoneId:s,sectionIndex:a+1},emphasis:{zoneEmphasis:i,sectionEmphasis:void 0,controlEmphasis:void 0},zoneGroupMetadata:r,zoneAudiences:o});return e.concat(this._composeFromSection(n,c))},[]):[]}}_composeFromSection(e,t){const n=this._view.getViewNode(e),a=n.traits.get(b.controls),i=N(this._view,n,b.sectionFactor);return a?a.reduce((e,n,a)=>{const r=ue(t,{position:{sectionFactor:i,controlIndex:a+1}});return e.concat(this._composeFromControl(n,r))},[]):[ue(t,{id:g,controlType:void 0,position:{controlIndex:1,sectionFactor:i}})]}_composeFromControl(e,t){const n=this._view.getViewNode(e),a=N(this._view,n,b.controlId);this._idMapGenerator.add({nodeId:e,uniqueId:a});const i=N(this._view,n,b.controlType),r=R(this._view,n,b.isControlAddedFromPersistedData)||!1,o=R(this._view,n,b.isControlFromSectionTemplate)||!1,s=ue(t,{id:a,controlType:i,addedFromPersistedData:r,isFromSectionTemplate:o});if(i===_.CanvasControlType.RTE){const e=N(this._view,n,b.innerHTML)||"",a=R(this._view,n,b.contentVersion),i=Object.assign(Object.assign(Object.assign({},s),{innerHTML:e}),a?{contentVersion:a}:void 0),r=n.traits.get(b.inlineControls);return(null==r?void 0:r.length)?r.reduce((e,n)=>{const a=ue(t,{rteInstanceId:i.id,position:{controlIndex:0}});return e.concat(this._composeFromControl(n,a))},[i]):[i]}if(i===_.CanvasControlType.WebPartZone){const e=N(this._view,n,b.webPartData),t=N(this._view,n,b.webPartId),a=R(this._view,n,b.webPartReservedSize);return 0===s.position.sectionFactor?(e.properties.isFullWidth=!0,!s.addedFromPersistedData&&a&&(a.reservedHeight=320)):!0===e.properties.isFullWidth&&delete e.properties.isFullWidth,[ue(s,Object.assign({webPartData:e,webPartId:t},a))]}throw new Error("Unrecognized control type in shared tree, the data is malformed")}}const pe=a._LogSource.create("buildLockedWebPartSubtree");function me(e){const{instanceId:t,webPartData:n,reservedSize:i}=e;try{m.Validate.isNotNullOrUndefined(t,"instanceId"),m.Validate.isNotNullOrUndefined(n,"webPartData"),m.Validate.isNotNullOrUndefined(i,"reservedSize")}catch(e){return void a._TraceLogger.logError(pe,e,"Invalid locked web part data")}return{definition:h.lockedWebPart,traits:{[b.lockedWebPartData]:[{definition:h.lockedWebPartData,payload:n}],[b.lockedWebPartInstanceId]:[{definition:h.lockedWebPartInstanceId,payload:t}],[b.lockedWebPartReservedSize]:[{definition:h.lockedWebPartReservedSize,payload:i}]}}}class _e{constructor(e){this._view=e}addLockedWebPart(e){const{instanceId:t}=e,n=function(e){const t=A(e).traits.get(b.lockedWebPartsRoot);if(null==t?void 0:t.length)return e.getViewNode(t[0]);throw new Error("Cannot find LockedWebParts root node. The tree data structure is compromised")}(this._view),a=n.traits.get(b.lockedWebParts);if(!a)throw new Error("Cannot find LockedWebParts trait. The tree data structure is compromised");if(a.some(e=>{const n=this._view.getViewNode(e);return N(this._view,n,b.lockedWebPartInstanceId)===t}))throw new Error("Cannot add new locked web part. The web part with same instance id already exists.");const i=me(e);return i?Object(H.e)().Change.insertTree(i,Object(H.e)().StablePlace.atEndOf({parent:n.identifier,label:b.lockedWebParts})):[]}updateLockedWebPart(e,t){const n=this._view.getViewNode(e),a=B(this._view,n,b.lockedWebPartReservedSize,t.reservedSize),i=B(this._view,n,b.lockedWebPartData,t.webPartData),r=[];return a&&r.push(a),i&&r.push(i),r}}class he{constructor(e){this._view=e}get canvas(){return this._canvasEditor||(this._canvasEditor=new ce(this._view)),this._canvasEditor}get lockedWebParts(){return this._lockedWebPartsEditor||(this._lockedWebPartsEditor=new _e(this._view)),this._lockedWebPartsEditor}}function be(e){return new ve(e).getLockedWebParts()}function ge(e,t){return new ve(e).getSingleLockedWebPart(t)}class ve{constructor(e){this._view=e,this._idMapGenerator=new k}getLockedWebParts(){return{webParts:this._composeLockedWebPartsCore()||new Map,idMap:this._idMapGenerator.getMap()}}getSingleLockedWebPart(e){return{webPart:this._composeSingleLockedWebPart(e),idMap:this._idMapGenerator.getMap()}}_composeLockedWebPartsCore(){var e;const t=new Map,n=null===(e=A(this._view).traits.get(b.lockedWebPartsRoot))||void 0===e?void 0:e[0];if(!n)return;const a=this._view.getViewNode(n).traits.get(b.lockedWebParts);return(null==a?void 0:a.length)?(a.forEach(e=>{const n=this._composeSingleLockedWebPart(e),{instanceId:a}=n;t.set(a,n),this._idMapGenerator.add({nodeId:e,uniqueId:a})}),t):void 0}_composeSingleLockedWebPart(e){const t=this._view.getViewNode(e),n=N(this._view,t,b.lockedWebPartInstanceId);return this._idMapGenerator.add({nodeId:e,uniqueId:n}),{instanceId:n,webPartData:N(this._view,t,b.lockedWebPartData),reservedSize:N(this._view,t,b.lockedWebPartReservedSize)}}}function ye(e){const t=de(e),n=be(e);return{canvasContent:t.canvasContent,webParts:n.webParts,idMap:(a=t.idMap,i=n.idMap,{fromNodeIdToUniqueId:e=>a.fromNodeIdToUniqueId(e)||i.fromNodeIdToUniqueId(e),fromUniqueIdToNodeId:e=>a.fromUniqueIdToNodeId(e)||i.fromUniqueIdToNodeId(e),_getLogForTelemetry:()=>[a._getLogForTelemetry(),i._getLogForTelemetry()].join(",")})};var a,i}function Se(e,t=!0){const n=e.currentView,a=A(n);return JSON.stringify(De(n,a,t),void 0,"  ")}function De(e,t,n){const{traits:a,payload:i}=t,r=Object(v.__rest)(t,["traits","payload"]),o={};return a.forEach((t,a)=>{const i=(r=a,Object.keys(b).find(e=>b[e]===r));var r;o[a+(i?` (${i})`:"")]=t.map(t=>De(e,e.getViewNode(t),n))}),Object.assign(Object.assign({},r),{payload:!n||r.definition!==h.webPartData&&r.definition!==h.innerHTML&&r.definition!==h.lockedWebPartData?i:Object(_.prunePIIFromStringData)("string"==typeof i?i:JSON.stringify(i)),traits:o})}class Ie{constructor(e){this._options=e,this.isDisposed=!1,this.dispose=()=>{this._unsubscriber(),this.isDisposed=!0},this._handleChange=(e,t,n,a)=>{this._currentSettings=e,this._options.onChange(e,t,this._interactionState,a)},this._ensureExistsInTree=()=>{const{coreSharedTreeManager:e,webPart:t}=this._options,{instanceId:n}=t;let a=this._getLatestNodeId(n);return a||(e.apply("LockedWebParts",e=>e.addLockedWebPart(t)),a=this._getLatestNodeId(n)),function(e){if(!e)throw new Error("Cannot locate locked web part in SharedTree")}(a),a},this._getLatestNodeId=e=>this._options.coreSharedTreeManager.getLocalSnapshot("LockedWebParts").idMap.fromUniqueIdToNodeId(e),this._treeNodeId=this._ensureExistsInTree(),this._unsubscriber=e.coreSharedTreeManager.subscribe("SingleLockedWebPart",this._handleChange,this._treeNodeId)}get webPart(){return this._currentSettings||(this._currentSettings=this._options.coreSharedTreeManager.getLocalSnapshot("SingleLockedWebPart",this._treeNodeId)),this._currentSettings.webPart}set webPart(e){var t;if(this.isDisposed)return;const n=!Object(o.isEqual)(null===(t=this._currentSettings)||void 0===t?void 0:t.webPart,e);this._options.coreSharedTreeManager.interactionState=this._interactionState,this._options.coreSharedTreeManager.apply("LockedWebParts",t=>t.updateLockedWebPart(this._treeNodeId,e),this._interactionState),n&&this._options.presenceManager.setLocalPresence({type:"WebPart",instanceId:e.instanceId,isEditAction:!0})}get _interactionState(){return{type:"LockedWebPart",state:{id:this._options.webPart.instanceId}}}}const xe=a._LogSource.create("TreeSubscription");class Ce{constructor(){this.isDisposed=!1,this._listenersMap=new Map,this._singleLockedWebPartListeners=new Map,this._listeners=(e,t)=>{if("SingleLockedWebPart"===e&&!t)throw new Error("Node ID must be specified for SingleLockedWebPart");let n;return n="SingleLockedWebPart"===e?this._singleLockedWebPartListeners.get(String(t)):this._listenersMap.get(e),n||(n=new Set,"SingleLockedWebPart"===e?this._singleLockedWebPartListeners.set(String(t),n):this._listenersMap.set(e,n)),n}}dispose(){this.isDisposed=!0,this._listenersMap.forEach(e=>{e.clear()}),this._listenersMap.clear(),this._singleLockedWebPartListeners.clear()}subscribe(e,t,n){if(this.isDisposed)return o.noop;const a=this._listeners(e,n);return a.add(t),()=>a.delete(t)}notifyChanges(e,t,n,i,r,o){const s=this._listeners(e,o);if(s.size){const e=t();s.forEach(t=>{try{t(e,n,i,r)}catch(e){a._TraceLogger.logError(xe,e)}})}}}var Oe=n("Z95U");const we=a._LogSource.create("CoreSharedTreeManager");class Ee{constructor(e){this._options=e,this.isDisposed=!1,this._lockedWebPartCommunicatorsMap=new Map,this._subscription=new Ce,this._applyingChanges=!1,this._isHandlingChange=!1,this._previousChangesQueue=[],this.apply=(e,t,n=!0)=>{if(this.isDisposed)return{type:"Disposed"};if(Array.isArray(t)||(t=[t]),!t.length)return{type:"NoChanges"};if(this._isHandlingChange){const t=new a._QosMonitor("CoAuth.OpsReentrancyError"),n=new Error("Ops reentrance while processing another op is not allowed");t.writeUnexpectedFailure(void 0,n,{at:e,trace:Object(i.getExtendedCallStack)()}),a._TraceLogger.logError(we,n)}this._checkout.openEdit();let r=!1;const o=Math.random()<.05?new a._QosMonitor("CoAuth.ApplySharedTreeChange"):void 0;let s,c;try{t.forEach(t=>{const n=t(this._getEditor(e,this._checkout.currentView));n&&(s=Array.isArray(n)?n:[n],s.length&&(r=!0,this._applyingChanges=!0,this._checkout.applyChanges(...s),this._applyingChanges=!1))}),null==o||o.writeSuccess()}catch(e){c=e;const t=new a._QosMonitorShareFailureWithCP("CoAuth.ApplySharedTreeChangeError",!1,[{errorModuleName:"CoAuth ApplySharedTreeChange Error",logFailure:this._options.serviceScope.consume(Oe._EditModeCustomerPromiseHandler.serviceKey).logFailure}]);null==o||o.writeUnexpectedFailure(void 0,c),t.writeUnexpectedFailure(void 0,c,Object.assign({changesToApply:s?JSON.stringify(s):void 0},this._getTelemetryExtraData())),r=!1}return this._previousChangesQueue.push(s?JSON.stringify(Le(s)):"N/A"),this._previousChangesQueue.length>10&&this._previousChangesQueue.shift(),r?(this._checkout.closeEdit(),n&&this._options.undoRedoStackManager.closeCurrentOperation(!0===n?void 0:JSON.stringify(n)),{type:"ChangesApplied"}):(this._checkout.abortEdit(),{type:"FailedToApply",error:c})},this._getTelemetryExtraData=()=>({previousChangesApplied:this._previousChangesQueue.join("\n")||"EMPTY",treeData:Se(this._options.sharedTree)}),this._getEditor=(e,t)=>({All:"All"===e?new he(t):void 0,Canvas:"Canvas"===e?new ce(t):void 0,LockedWebParts:"LockedWebParts"===e?new _e(t):void 0}[e]),this._handleViewChange=(e,t)=>{this._isHandlingChange=!0;try{if(this._options.undoRedoStackManager.mode===c.UndoIntermediate||this._options.undoRedoStackManager.mode===c.RedoIntermediate)return;const n=e.delta(t),a={isCanvasChanged:!1,hasUnmonitoredChange:!1,changedNodes:new Set};this._updateDataChangeFlags(e,n.removed,a),this._updateDataChangeFlags(t,n.changed,a),this._updateDataChangeFlags(t,n.added,a);const{isCanvasChanged:i,changedNodes:r,hasUnmonitoredChange:o}=a,s="UndoRedo"===this._changeSource&&this.interactionState,d=new Set;r.forEach(e=>d.add(e.identifier)),i&&this._subscription.notifyChanges("Canvas",()=>this.getLocalSnapshot("Canvas"),this._changeSource,s,d);let l=!1;r.forEach(e=>{e.definition===h.lockedWebPart&&(l=!0,this._subscription.notifyChanges("SingleLockedWebPart",()=>this.getLocalSnapshot("SingleLockedWebPart",e.identifier),this._changeSource,s,d,e.identifier))}),l&&this._subscription.notifyChanges("LockedWebParts",()=>this.getLocalSnapshot("LockedWebParts"),this._changeSource,s,d),(i||l||o)&&this._subscription.notifyChanges("All",()=>this.getLocalSnapshot("All"),this._changeSource,s,d)}finally{this._isHandlingChange=!1,this._options.onDataChanged("LocalChange"===this._changeSource||"UndoRedo"===this._changeSource)}},this._updateDataChangeFlags=(e,t,n)=>{t.forEach(t=>{const a=function(e,t){let n=e.getViewNode(t);const a=[];for(;n&&n.definition!==h.documentRoot;)try{Ae.indexOf(n.definition)>-1&&a.push(n),n=e.getParentViewNode(n.identifier)}catch(e){return a}return a}(e,t);a.length?a.forEach(e=>{switch(e.definition){case h.control:case h.zone:n.isCanvasChanged=!0,n.changedNodes.add(e);break;case h.canvasRoot:n.isCanvasChanged=!0;break;case h.lockedWebPart:n.changedNodes.add(e)}}):n.hasUnmonitoredChange=!0})},this._checkout=new(Object(H.e)().EagerCheckout)(this._options.sharedTree),this._checkout.on("viewChange",this._handleViewChange),T.instance.addCallbackForExtraLogs("CoreSharedTree",e=>function(e,t=!0){return["============================================================","Authoring SharedTree Data:",Se(e,t),"============================================================"]}(this._options.sharedTree,e))}dispose(){this._subscription.dispose(),this._checkout.dispose(),this._lockedWebPartCommunicatorsMap.forEach(e=>e.dispose()),this._lockedWebPartCommunicatorsMap.clear(),this.isDisposed=!0}getLocalSnapshot(e,t){return{All:"All"===e?ye(this._currentView):void 0,Canvas:"Canvas"===e?de(this._currentView):void 0,LockedWebParts:"LockedWebParts"===e?be(this._currentView):void 0,SingleLockedWebPart:"SingleLockedWebPart"===e?ge(this._currentView,t):void 0}[e]}subscribe(e,t,n){return this._subscription.subscribe(e,t,n)}getLockedWebPartCommunicator(e,t){let n=this._lockedWebPartCommunicatorsMap.get(e);if(!n&&t){const i=new a._QosMonitor("CoAuth.InitLockedWebPartCommunicator");try{n=new Ie(Object.assign(Object.assign({coreSharedTreeManager:this},t()),{presenceManager:this._options.presenceManager})),this._lockedWebPartCommunicatorsMap.set(e,n),i.writeSuccess()}catch(t){throw i.writeUnexpectedFailure(void 0,t,{id:e}),t}}return n}get interactionState(){const e=this._options.undoRedoStackManager.state;return e?JSON.parse(e):{type:"None"}}set interactionState(e){this._options.undoRedoStackManager.state=JSON.stringify(e)}get _changeSource(){return this._applyingChanges?"LocalChange":this._options.undoRedoStackManager.mode!==c.None?"UndoRedo":"Remote"}get _currentView(){return this._checkout.currentView}}const Ae=[h.canvasRoot,h.control,h.zone,h.lockedWebPart];function Le(e){return Object.keys(e).forEach(t=>{"payload"===t?e[t]="<pruned>":"object"==typeof e[t]&&Le(e[t])}),e}var ke,Me;!function(e){e.CoreAuthoring="CoreAuthoring",e.AgentScheduler="AgentScheduler",e.Metadata="Metadata",e.SessionId="SessionId"}(ke||(ke={})),function(e){e.IsDefaultThumbnail="IsDefaultThumbnail",e.PageThumbnail="PageThumbnail",e.IsDefaultDescription="IsDefaultDescription",e.PageDescription="PageDescription",e.IsSpellCheckEnabled="IsSpellCheckEnabled",e.IsRecommendedItemsEnabled="IsRecommendedItemsEnabled",e.IsCommentSectionEnabled="IsCommentSectionEnabled"}(Me||(Me={}));class Pe{constructor(e){this._eventEmitter=new r.EventEmitter,this.updateMetadata=(e,t)=>{this._metadataDirectory.set(e,t)},this.getMetadata=e=>this._metadataDirectory.get(e),this.getAllMetadata=()=>{const e=new Map;return this._metadataDirectory.forEach((t,n)=>{e.set(n,t)}),e},this.on=(e,t)=>{this._eventEmitter.on(e,t)},this._handleMetadataChanged=(e,t,n)=>{if(!t){const{key:t}=e;this._eventEmitter.emit("METADATA_CHANGED_REMOTELY",{key:t,previousValue:e.previousValue,value:this._metadataDirectory.get(t)})}this._onDataChanged(t)};const{rootDirectory:t,onDataChanged:n}=e;this._onDataChanged=n,t.hasSubDirectory(ke.Metadata)?this._metadataDirectory=t.getSubDirectory(ke.Metadata):P("NoMetadataSubDirectory",new Error("Cannot find metadata directory, data structure is compromised.")),this._metadataDirectory.on("containedValueChanged",this._handleMetadataChanged)}}const Te=a._LogSource.create("BroadcastManager");class Ue{constructor(e,t){this._runtime=t,this._listenersMap=new Map,this._previousSignalsToLog=[],this.dispose=()=>{this._connection.runtime.off("signal",this._handleIncomingSignal),this._listenersMap.clear()},this.broadcastMessage=(e,t)=>{if(this._canSendSignals){if(t)return this._connection.runtime.submitSignal(e,t),this._addSignalsToLog(`Sent: ${e}-${JSON.stringify(t)}`),!0;{const e=new Error("Skipped broadcasting, failed to get user info.");a._TraceLogger.logError(Te,e),new a._QosMonitor("CoAuth.BroadcastError").writeUnexpectedFailure(void 0,e)}}return!1},this.addBroadcastListener=(e,t)=>{const n=this._getListenersSet(e);return n.add(t),()=>{n.delete(t)}},this._handleIncomingSignal=(e,t)=>{!t&&e.clientId&&(this._handleIncomingBroadcast(e.type,e.content,e.clientId),this._addSignalsToLog(`Received: ${e.type}-${JSON.stringify(e.content)} from ${e.clientId}`))},this._handleIncomingBroadcast=(e,t,n)=>{const a=this._listenersMap.get(e);null==a||a.forEach(e=>{const a=this._wrapMessageWithUserInfo(t,n);a&&e(a)})},this._wrapMessageWithUserInfo=(e,t)=>{var n;const a=null===(n=this._runtime.getAudience().getMember(t))||void 0===n?void 0:n.user;if((null==a?void 0:a.id)&&a.name)return{from:{userId:a.id,clientId:t,displayName:a.name},body:e}},this._addSignalsToLog=e=>{this._previousSignalsToLog.push(e),this._previousSignalsToLog.length>100&&this._previousSignalsToLog.shift()},t.on("signal",this._handleIncomingSignal),this._connection={context:e,runtime:t},T.instance.addCallbackForExtraLogs("Last 100 signals",()=>this._previousSignalsToLog)}_getListenersSet(e){const t=this._listenersMap.get(e);if(t)return t;{const t=new Set;return this._listenersMap.set(e,t),t}}get _canSendSignals(){const{context:e,runtime:t}=this._connection,{readOnlyInfo:n}=t.deltaManager,a=!(n.readonly&&n.storageOnly);return e.connected&&a}}var Fe;!function(e){e.UpdatePresence="UpdatePresence",e.PageStatus="PageStatus"}(Fe||(Fe={}));var He=n("y88i");const Re=["#004E8C","#005E50","#0078D4","#038387","#373277","#393939","#498205","#4F6BED","#567C73","#603D30","#69797E","#750B1C","#7A7574","#8764B8","#881798","#986F0B","#A4262C","#C239B3","#CA5010","#D13438","#E3008C"];function Ne(e,t,n){return e.length!==t.length||!Object(o.isEqual)(e.map(n),t.map(n))}function Be(e){return e.sort((e,t)=>t.joinTime.getTime()-e.joinTime.getTime())}function je(e){Re.map(t=>{e[t]=!1})}function Ve(e,t){if(null==e?void 0:e.color)return e.color;let n=Object.keys(t).filter(e=>!t[e]);0===n.length&&(je(t),n=Object.keys(t));const a=n[Math.floor(Math.random()*n.length)];return t[a]=!0,a}var ze=n("cDcd"),Ge=n.n(ze),Ke=n("5pbq"),We=n("jOlS");We.loadStyles('.a_b_6bb4a585{border-style:solid;border-width:3px;bottom:0;left:0;pointer-events:none;position:absolute;right:0;top:0}.a_b_6bb4a585 .b_b_6bb4a585{display:flex;pointer-events:all;position:absolute;top:-16px;z-index:2}[dir=ltr] .a_b_6bb4a585 .b_b_6bb4a585{right:5px}[dir=rtl] .a_b_6bb4a585 .b_b_6bb4a585{left:5px}.a_b_6bb4a585 .o_b_6bb4a585{padding-right:8px}.a_b_6bb4a585 .o_b_6bb4a585 .e_b_6bb4a585{display:inline-block;position:relative;width:18px}.a_b_6bb4a585 .p_b_6bb4a585{align-items:flex-end;flex-direction:column}.a_b_6bb4a585 .p_b_6bb4a585 .q_b_6bb4a585{border:1px solid "[theme:white, default: #ffffff]";border-radius:20px;color:#fff;display:flex;padding:4px 8px}',!0);var qe="b_b_6bb4a585",Qe="e_b_6bb4a585";function Ye(e,t){const{data:n,receivedTime:a}=e||{},i=a?a.getTime():0,r=(null==n?void 0:n.isEditAction)||!1,o=t||r&&(null==n?void 0:n.editActionTimeoutInMS)||15e3,s=ze.useCallback(()=>(new Date).getTime()-i,[i]),[c,d]=ze.useState(ze.useMemo(()=>r&&s()<o,[])),l=ze.useRef(void 0);l.current=[c,d];const u=ze.useRef();return ze.useEffect(()=>{if(!r)return;const e=s();if(e<o){const[t,n]=l.current;t||n(!0),u.current&&window.clearTimeout(u.current),u.current=window.setTimeout(()=>{n(!1)},o-e)}},[i,r]),c}We.loadStyles('.a_c_6bb4a585{height:22px;position:relative;width:22px}.a_c_6bb4a585.r_c_6bb4a585{background-color:"[theme:white, default: #ffffff]";border:1px solid "[theme:white, default: #ffffff]";border-radius:50%;margin:2px}.a_c_6bb4a585 .s_c_6bb4a585{animation-duration:.7s;animation-iteration-count:infinite;animation-name:t_c_6bb4a585;animation-timing-function:ease-out;color:"[theme:white, default: #ffffff]";display:inline-block;font-size:28px;position:relative;top:-15px}[dir=ltr] .a_c_6bb4a585 .s_c_6bb4a585{left:2px}[dir=rtl] .a_c_6bb4a585 .s_c_6bb4a585{right:2px}.a_c_6bb4a585 .s_c_6bb4a585:nth-child(2){animation-delay:125ms}.a_c_6bb4a585 .s_c_6bb4a585:nth-child(3){animation-delay:.25s}@keyframes t_c_6bb4a585{0%{transform:none}33%{transform:translateY(-7px)}66%{transform:none}}',!0);var Je="s_c_6bb4a585";function Xe(e){const{classNames:t,style:n}=e;return Ge.a.createElement("div",{className:Object(Ke.css)("a_c_6bb4a585",t),style:n},Ge.a.createElement("span",{className:Je},"."),Ge.a.createElement("span",{className:Je},"."),Ge.a.createElement("span",{className:Je},"."))}function Ze(e){const{presence:t}=e,{author:n,color:a}=t,i=Ye(t,5e3);return ze.createElement("div",{className:"q_b_6bb4a585",style:{backgroundColor:a}},i&&ze.createElement(Xe,null),n.displayName)}function $e(e){const{userId:t,personaSize:n,classNames:a}=e,r=(o=t,i.SPUtility.getUserPhotoUrl(o.toLowerCase(),He.SPAlternativeUrls.UserPhotoSize.Small));var o;return Ge.a.createElement(Ke.PersonaCoin,{coinProps:{className:Object(Ke.css)("a_h_6bb4a585",a)},imageUrl:r,size:n||Ke.PersonaSize.size24})}We.loadStyles('.a_h_6bb4a585{background-color:"[theme:white, default: #ffffff]";border-radius:50%;padding:2px;width:-moz-fit-content;width:fit-content}',!0),We.loadStyles('.w_f_6bb4a585 .x_f_6bb4a585{position:relative}.w_f_6bb4a585 .x_f_6bb4a585:before{animation:y_f_6bb4a585 1s;bottom:0;box-shadow:0 0 0 calc(var(--size)/4) transparent;content:"";left:0;position:absolute;right:0;top:0;z-index:1}@keyframes y_f_6bb4a585{0%{box-shadow:0 0 0 0 var(--color)}}',!0);var et="w_f_6bb4a585";function tt(e,t,n,a){const i=t?"x_f_6bb4a585":void 0;return ze.useLayoutEffect(()=>{if(e.current){const{current:i}=e;t?(i.classList.remove(et),i.style.setProperty("--size",`${a}px`),i.style.setProperty("--color",n),window.requestAnimationFrame(()=>{i.classList.add(et)})):(i.classList.remove(et),i.style.removeProperty("--size"),i.style.removeProperty("--color"))}},[t]),i}function nt(e){const{presence:t,presenceAvatarElement:n,presenceEditingElement:a}=e;return Ye(t,5e3)?a:n}function at(e){const{presence:t,highlightLockCount:n}=e,{author:a,color:i}=t,r=ze.useRef(null),o=tt(r,n,i,18),s=ze.createElement($e,{userId:a.userId,classNames:o}),c=ze.createElement(Xe,{classNames:Object(Ke.css)("r_c_6bb4a585",o),style:{backgroundColor:i}});return ze.createElement("div",{ref:r,"aria-label":a.userId},ze.createElement(nt,{presence:t,presenceAvatarElement:s,presenceEditingElement:c}))}function it(e){const{overflowPresenceListLength:t}=e,n=`+${t}`;return Ge.a.createElement("div",{className:"a_g_6bb4a585"},Ge.a.createElement("span",{className:"z_g_6bb4a585"},n))}function rt(e){const[t,n]=ze.useState(!1),{presences:a,selectedByCurrentUser:i,style:r,lockedBy:o,highlightLockCount:s,"data-automation-id":c}=e,d=null==o?void 0:o.author.clientId,l=ze.useCallback(e=>{const{clientId:t}=e.author;return ze.createElement("div",{key:t,className:Qe},ze.createElement(at,{presence:e,highlightLockCount:t===d?s:void 0}))},[d,s]),u=a.slice(0,3).map(l);a.length>3&&u.push(ze.createElement("div",{key:"PresenceOverflowCoinContainer","data-automation-id":"PresenceOverflowCoin",className:Qe},ze.createElement(it,{overflowPresenceListLength:a.length-3})));const f=ze.useCallback(()=>n(!0),[]),p=ze.useCallback(()=>n(!1),[]),m=a.map(e=>{const{clientId:t}=e.author;return ze.createElement("div",{key:t,className:Qe},ze.createElement(Ze,{presence:e}))});return ze.createElement("div",{className:"a_b_6bb4a585",style:Object.assign(Object.assign({},r),i?{}:{borderColor:a[0].color}),onMouseEnter:f,onMouseLeave:p,"data-automation-id":c},t?ze.createElement("div",{className:Object(Ke.css)(qe,"p_b_6bb4a585")},m):ze.createElement("div",{className:Object(Ke.css)(qe,"o_b_6bb4a585")},u))}We.loadStyles('.a_g_6bb4a585{background-color:"[theme:white, default: #ffffff]";border:1px solid "[theme:neutralsecondary, default: #605e5c]";border-radius:50%;height:23px;margin:2px 0;position:relative;width:23px}.a_g_6bb4a585 .z_g_6bb4a585{color:"[theme:neutralDark, default: #201f1e]";font-size:12px;margin:2.5px 3px}',!0),We.loadStyles('.a_a_6bb4a585{display:flex;padding:3px 0;position:relative}.a_a_6bb4a585 .b_a_6bb4a585{display:flex;gap:2px}.a_a_6bb4a585 .b_a_6bb4a585 .c_a_6bb4a585{display:inline-block;margin:3px;position:relative}@media (max-width:1024px){.a_a_6bb4a585 .b_a_6bb4a585 .c_a_6bb4a585{margin:3px -5px}}.e_a_6bb4a585{background-color:"[theme:white, default: #ffffff]";border-radius:50%;border-style:solid;border-width:3px;display:inline-block;position:relative}@media (max-width:1024px){.e_a_6bb4a585{margin:0 -5px}}.e_a_6bb4a585.f_a_6bb4a585{border-width:1px;cursor:pointer;display:block;height:-moz-fit-content;height:fit-content}.g_a_6bb4a585{max-height:444px;overflow:auto}.g_a_6bb4a585.h_a_6bb4a585 .i_a_6bb4a585:hover{background-color:"[theme:neutralLight, default: #edebe9]"}.g_a_6bb4a585 .j_a_6bb4a585{border-bottom:1px solid;color:"[theme:neutralSecondary, default: #605e5c]";display:block;padding:8px 12px}.i_a_6bb4a585{align-items:center;background-color:unset;border:unset;cursor:pointer;display:flex;padding:8px;width:100%}.k_a_6bb4a585{display:flex;flex-direction:column}.l_a_6bb4a585{color:"[theme:neutralPrimary, default: #323130]";font-size:17px;padding:0 8px;text-align:left}.m_a_6bb4a585 .l_a_6bb4a585{color:#979593}.n_a_6bb4a585{color:"[theme:neutralSecondary, default: #605e5c]";padding:0 8px;text-align:left}.m_a_6bb4a585 .n_a_6bb4a585{color:#979593}',!0);var ot="i_a_6bb4a585",st="k_a_6bb4a585",ct="l_a_6bb4a585",dt="m_a_6bb4a585",lt="n_a_6bb4a585";function ut(e){const{size:t,onClick:n}=e;return Ge.a.createElement(Ke.IconButton,{onClick:n,className:Object(Ke.css)("a_e_6bb4a585",{v_e_6bb4a585:ft(t)}),tabIndex:ft(t)?-1:void 0,iconProps:{iconName:"PeopleAdd",className:"u_e_6bb4a585"}})}We.loadStyles('.a_e_6bb4a585{align-items:center;background-color:"[theme:white, default: #ffffff]";cursor:pointer;display:flex;margin:2px;position:relative;width:34px}.a_e_6bb4a585 .u_e_6bb4a585{color:"[theme:neutralSecondary, default: #605e5c]";font-size:18px}.a_e_6bb4a585.v_e_6bb4a585{border:1px solid "[theme:neutralsecondary, default: #605e5c]";border-radius:50%;height:44px;width:44px}.a_e_6bb4a585.v_e_6bb4a585 span{margin:auto}',!0);const ft=e=>"Large"===e;var pt,mt,_t={host:"ms-HoverCard-host"};!function(e){e[e.hover=0]="hover",e[e.hotKey=1]="hotKey"}(pt||(pt={})),function(e){e.plain="PlainCard",e.expanding="ExpandingCard"}(mt||(mt={}));var ht,bt={root:"ms-ExpandingCard-root",compactCard:"ms-ExpandingCard-compactCard",expandedCard:"ms-ExpandingCard-expandedCard",expandedCardScroll:"ms-ExpandingCard-expandedCardScrollRegion"};!function(e){e[e.compact=0]="compact",e[e.expanded=1]="expanded"}(ht||(ht={}));var gt=function(e){var t=e.gapSpace,n=void 0===t?0:t,a=e.directionalHint,i=void 0===a?Ke.DirectionalHint.bottomLeftEdge:a,r=e.directionalHintFixed,o=e.targetElement,s=e.firstFocus,c=e.trapFocus,d=e.onLeave,l=e.className,u=e.finalHeight,f=e.content,p=e.calloutProps,m=Object(v.__assign)(Object(v.__assign)(Object(v.__assign)({},Object(Ke.getNativeProps)(e,Ke.divProperties)),{className:l,target:o,isBeakVisible:!1,directionalHint:i,directionalHintFixed:r,finalHeight:u,minPagePadding:24,onDismiss:d,gapSpace:n}),p);return ze.createElement(ze.Fragment,null,c?ze.createElement(Ke.FocusTrapCallout,Object(v.__assign)({},m,{focusTrapProps:{forceFocusInsideTrap:!1,isClickableOutsideFocusTrap:!0,disableFirstFocus:!s}}),f):ze.createElement(Ke.Callout,Object(v.__assign)({},m),f))},vt=Object(Ke.classNamesFunction)(),yt=function(e){function t(t){var n=e.call(this,t)||this;return n._expandedElem=ze.createRef(),n._onKeyDown=function(e){e.which===Ke.KeyCodes.escape&&n.props.onLeave&&n.props.onLeave(e)},n._onRenderCompactCard=function(){return ze.createElement("div",{className:n._classNames.compactCard},n.props.onRenderCompactCard(n.props.renderData))},n._onRenderExpandedCard=function(){return!n.state.firstFrameRendered&&n._async.requestAnimationFrame(function(){n.setState({firstFrameRendered:!0})}),ze.createElement("div",{className:n._classNames.expandedCard,ref:n._expandedElem},ze.createElement("div",{className:n._classNames.expandedCardScroll},n.props.onRenderExpandedCard&&n.props.onRenderExpandedCard(n.props.renderData)))},n._checkNeedsScroll=function(){var e=n.props.expandedCardHeight;n._async.requestAnimationFrame(function(){n._expandedElem.current&&n._expandedElem.current.scrollHeight>=e&&n.setState({needsScroll:!0})})},n._async=new Ke.Async(n),Object(Ke.initializeComponentRef)(n),n.state={firstFrameRendered:!1,needsScroll:!1},n}return Object(v.__extends)(t,e),t.prototype.componentDidMount=function(){this._checkNeedsScroll()},t.prototype.componentWillUnmount=function(){this._async.dispose()},t.prototype.render=function(){var e=this.props,t=e.styles,n=e.compactCardHeight,a=e.expandedCardHeight,i=e.theme,r=e.mode,o=e.className,s=this.state,c=s.needsScroll,d=s.firstFrameRendered,l=n+a;this._classNames=vt(t,{theme:i,compactCardHeight:n,className:o,expandedCardHeight:a,needsScroll:c,expandedCardFirstFrameRendered:r===ht.expanded&&d});var u=ze.createElement("div",{onMouseEnter:this.props.onEnter,onMouseLeave:this.props.onLeave,onKeyDown:this._onKeyDown},this._onRenderCompactCard(),this._onRenderExpandedCard());return ze.createElement(gt,Object(v.__assign)({},this.props,{content:u,finalHeight:l,className:this._classNames.root}))},t.defaultProps={compactCardHeight:156,expandedCardHeight:384,directionalHintFixed:!0},t}(ze.Component),St=Object(Ke.styled)(yt,function(e){var t,n=e.theme,a=e.needsScroll,i=e.expandedCardFirstFrameRendered,r=e.compactCardHeight,o=e.expandedCardHeight,s=e.className,c=n.palette,d=Object(Ke.getGlobalClassNames)(bt,n);return{root:[d.root,{width:320,pointerEvents:"none",selectors:(t={},t[Ke.HighContrastSelector]={border:"1px solid WindowText"},t)},s],compactCard:[d.compactCard,{pointerEvents:"auto",position:"relative",height:r}],expandedCard:[d.expandedCard,{height:1,overflowY:"hidden",pointerEvents:"auto",transition:"height 0.467s cubic-bezier(0.5, 0, 0, 1)",selectors:{":before":{content:'""',position:"relative",display:"block",top:0,left:24,width:272,height:1,backgroundColor:c.neutralLighter}}},i&&{height:o}],expandedCardScroll:[d.expandedCardScroll,a&&{height:"100%",boxSizing:"border-box",overflowY:"auto"}]}},void 0,{scope:"ExpandingCard"}),Dt={root:"ms-PlainCard-root"},It=Object(Ke.classNamesFunction)(),xt=function(e){function t(t){var n=e.call(this,t)||this;return n._onKeyDown=function(e){e.which===Ke.KeyCodes.escape&&n.props.onLeave&&n.props.onLeave(e)},Object(Ke.initializeComponentRef)(n),n}return Object(v.__extends)(t,e),t.prototype.render=function(){var e=this.props,t=e.styles,n=e.theme,a=e.className;this._classNames=It(t,{theme:n,className:a});var i=ze.createElement("div",{onMouseEnter:this.props.onEnter,onMouseLeave:this.props.onLeave,onKeyDown:this._onKeyDown},this.props.onRenderPlainCard(this.props.renderData));return ze.createElement(gt,Object(v.__assign)({},this.props,{content:i,className:this._classNames.root}))},t}(ze.Component),Ct=Object(Ke.styled)(xt,function(e){var t,n=e.theme,a=e.className;return{root:[Object(Ke.getGlobalClassNames)(Dt,n).root,{pointerEvents:"auto",selectors:(t={},t[Ke.HighContrastSelector]={border:"1px solid WindowText"},t)},a]}},void 0,{scope:"PlainCard"}),Ot=Object(Ke.classNamesFunction)(),wt=function(e){function t(t){var n=e.call(this,t)||this;return n._hoverCard=ze.createRef(),n.dismiss=function(e){n._async.clearTimeout(n._openTimerId),n._async.clearTimeout(n._dismissTimerId),e?n._dismissTimerId=n._async.setTimeout(function(){n._setDismissedState()},n.props.cardDismissDelay):n._setDismissedState()},n._cardOpen=function(e){n._shouldBlockHoverCard()||"keydown"===e.type&&e.which!==n.props.openHotKey||(n._async.clearTimeout(n._dismissTimerId),"mouseenter"===e.type&&(n._currentMouseTarget=e.currentTarget),n._executeCardOpen(e))},n._executeCardOpen=function(e){n._async.clearTimeout(n._openTimerId),n._openTimerId=n._async.setTimeout(function(){n.setState(function(t){return t.isHoverCardVisible?t:{isHoverCardVisible:!0,mode:ht.compact,openMode:"keydown"===e.type?pt.hotKey:pt.hover}})},n.props.cardOpenDelay)},n._cardDismiss=function(e,t){if(e){if(!(t instanceof MouseEvent))return;if("keydown"===t.type&&t.which!==Ke.KeyCodes.escape)return;n.props.sticky||n._currentMouseTarget!==t.currentTarget&&t.which!==Ke.KeyCodes.escape||n.dismiss(!0)}else{if(n.props.sticky&&!(t instanceof MouseEvent)&&t.nativeEvent instanceof MouseEvent&&"mouseleave"===t.type)return;n.dismiss(!0)}},n._setDismissedState=function(){n.setState({isHoverCardVisible:!1,mode:ht.compact,openMode:pt.hover})},n._instantOpenAsExpanded=function(e){n._async.clearTimeout(n._dismissTimerId),n.setState(function(e){return e.isHoverCardVisible?e:{isHoverCardVisible:!0,mode:ht.expanded}})},n._setEventListeners=function(){var e=n.props,t=e.trapFocus,a=e.instantOpenOnClick,i=e.eventListenerTarget,r=i?n._getTargetElement(i):n._getTargetElement(n.props.target),o=n._nativeDismissEvent;r&&(n._events.on(r,"mouseenter",n._cardOpen),n._events.on(r,"mouseleave",o),t?n._events.on(r,"keydown",n._cardOpen):(n._events.on(r,"focus",n._cardOpen),n._events.on(r,"blur",o)),a?n._events.on(r,"click",n._instantOpenAsExpanded):(n._events.on(r,"mousedown",o),n._events.on(r,"keydown",o)))},Object(Ke.initializeComponentRef)(n),n._async=new Ke.Async(n),n._events=new Ke.EventGroup(n),n._nativeDismissEvent=n._cardDismiss.bind(n,!0),n._childDismissEvent=n._cardDismiss.bind(n,!1),n.state={isHoverCardVisible:!1,mode:ht.compact,openMode:pt.hover},n}return Object(v.__extends)(t,e),t.prototype.componentDidMount=function(){this._setEventListeners()},t.prototype.componentWillUnmount=function(){this._async.dispose(),this._events.dispose()},t.prototype.componentDidUpdate=function(e,t){var n=this;e.target!==this.props.target&&(this._events.off(),this._setEventListeners()),t.isHoverCardVisible!==this.state.isHoverCardVisible&&(this.state.isHoverCardVisible?(this._async.setTimeout(function(){n.setState({mode:ht.expanded},function(){n.props.onCardExpand&&n.props.onCardExpand()})},this.props.expandedCardOpenDelay),this.props.onCardVisible&&this.props.onCardVisible()):(this.setState({mode:ht.compact}),this.props.onCardHide&&this.props.onCardHide()))},t.prototype.render=function(){var e=this.props,t=e.expandingCardProps,n=e.children,a=e.id,i=e.setAriaDescribedBy,r=void 0===i||i,o=e.styles,s=e.theme,c=e.className,d=e.type,l=e.plainCardProps,u=e.trapFocus,f=e.setInitialFocus,p=this.state,m=p.isHoverCardVisible,_=p.mode,h=p.openMode,b=a||Object(Ke.getId)("hoverCard");this._classNames=Ot(o,{theme:s,className:c});var g=Object(v.__assign)(Object(v.__assign)({},Object(Ke.getNativeProps)(this.props,Ke.divProperties)),{id:b,trapFocus:!!u,firstFocus:f||h===pt.hotKey,targetElement:this._getTargetElement(this.props.target),onEnter:this._cardOpen,onLeave:this._childDismissEvent}),y=Object(v.__assign)(Object(v.__assign)(Object(v.__assign)({},t),g),{mode:_}),S=Object(v.__assign)(Object(v.__assign)({},l),g);return ze.createElement("div",{className:this._classNames.host,ref:this._hoverCard,"aria-describedby":r&&m?b:void 0,"data-is-focusable":!this.props.target},n,m&&(d===mt.expanding?ze.createElement(St,Object(v.__assign)({},y)):ze.createElement(Ct,Object(v.__assign)({},S))))},t.prototype._getTargetElement=function(e){switch(typeof e){case"string":return Object(Ke.getDocument)().querySelector(e);case"object":return e;default:return this._hoverCard.current||void 0}},t.prototype._shouldBlockHoverCard=function(){return!(!this.props.shouldBlockHoverCard||!this.props.shouldBlockHoverCard())},t.defaultProps={cardOpenDelay:500,cardDismissDelay:100,expandedCardOpenDelay:1500,instantOpenOnClick:!1,setInitialFocus:!1,openHotKey:Ke.KeyCodes.c,type:mt.expanding},t}(ze.Component),Et=Object(Ke.styled)(wt,function(e){var t=e.className,n=e.theme;return{host:[Object(Ke.getGlobalClassNames)(_t,n).host,t]}},void 0,{scope:"HoverCard"}),At=n("X+PM"),Lt=n("I6O9");function kt(e){return"RTE"===e.type}function Mt(e){return"WebPart"===e.type}function Pt(e){return"Zone"===e.type}function Tt(e){return kt(e)||Mt(e)}function Ut(e){return"ACTIVE"===e.type}function Ft(e){return"INACTIVE"===e.type}function Ht(e){return Tt(e)||Pt(e)}function Rt(e,t){const{type:n}=e.data,{type:a}=t.data;return"INACTIVE"!==n&&"INACTIVE"===a?-1:"INACTIVE"===n&&"INACTIVE"!==a?1:e.startTime.getTime()-t.startTime.getTime()}var Nt=n("ffNP");function Bt(e,t,n){return Ft(e)?Nt.a:Ut(e)?Nt.i:m.Text.format(e.isEditAction?Nt.n:Nt.r,function(e,t,n){if(Mt(e)){const a=function(e,t){return t.filter(t=>t.instanceId===e)[0]||void 0}(e.instanceId,t);if(a)return m.Text.format(Nt.s,function(e,t,n){var a,i,r=e.id,s=e.properties,c=e.title,d="f3bc67ee-015d-4678-a95f-c7e90ea62c1e"===r,l=d?null===(a=null==s?void 0:s.aceData)||void 0===a?void 0:a.title:c;if(d&&l)return l;if(!(i=Lt.SPComponentLoader.tryGetManifestById(d?null==s?void 0:s.aceManifestId:r))||!i.preconfiguredEntries||!i.preconfiguredEntries.length)return l;var u=i.preconfiguredEntries,f=u.length,p=0;if(f>1)for(var m=function(e){var t=u[e].title;if(Object.keys(t).some(function(e){return t[e]===l}))return p=e,"break"},_=0;_<f&&"break"!==m(_);_++);var h=u[p].title,b=Object(o.find)(Object.keys(h),function(e){return e.toLowerCase()===n.toLowerCase()});return b&&h[b]||l}(a,0,function(e){return e.consume(At.PageContext.serviceKey).cultureInfo.currentUICultureName.toLowerCase()}(n)))}else{if(kt(e))return m.Text.format(Nt.s,Nt.o);if(Pt(e))return Nt.e}}(e,t,n))}function jt(e){return Ht(e)?()=>{const t=Pt(e)?e.zoneId:e.instanceId,n=document.getElementById(t)||void 0;null==n||n.scrollIntoView()}:void 0}function Vt(e,t,n){const{author:a,color:i}=e;return ze.createElement("div",{className:"e_a_6bb4a585",style:{borderColor:Ft(e.data)?"transparent":i},"aria-label":a.userId},ze.createElement($e,{userId:a.userId,personaSize:t,classNames:n}))}function zt(e){const{presence:t,webPartDataCollection:n,serviceScope:a}=e,{author:i,data:r}=t,o=Ft(r);return Ge.a.createElement(Et,{key:i.clientId,plainCardProps:{onRenderPlainCard:()=>Ge.a.createElement("div",{className:Object(Ke.css)(ot,{[dt]:o}),onClick:jt(r),role:"button","data-automation-id":"PresenceHoverCard"},Ge.a.createElement($e,{userId:i.userId,personaSize:Ke.PersonaSize.size40}),Ge.a.createElement("div",{className:st},Ge.a.createElement("span",{className:ct,"data-automation-id":"PresenceHoverCardDisplayName"},i.displayName),Ge.a.createElement("span",{className:lt,"data-automation-id":"PresenceHoverCardStatus"},Bt(r,n,a)))),directionalHint:Ke.DirectionalHint.bottomCenter,calloutProps:{isBeakVisible:!0}},instantOpenOnClick:!0,type:mt.plain},Vt(t))}function Gt(e){const{presences:t,webPartDataCollection:n,serviceScope:a,onShareButtonClick:i}=e;return Ge.a.createElement(Et,{plainCardProps:{onRenderPlainCard:()=>{return Ge.a.createElement("div",{className:Object(Ke.css)("g_a_6bb4a585","h_a_6bb4a585"),"data-automation-id":"PresenceOverflowHoverCard"},Ge.a.createElement("span",{className:"j_a_6bb4a585"},(e=t.length,m.Text.format(Nt.c,e))),t.map(e=>{const{author:t,data:i}=e,r=Ft(i);return Ge.a.createElement("button",{key:t.clientId,className:Object(Ke.css)(ot,{[dt]:r}),onClick:jt(i),"aria-label":t.userId},Vt(e,Ke.PersonaSize.size40,void 0),Ge.a.createElement("div",{className:st},Ge.a.createElement("span",{className:ct},t.displayName),Ge.a.createElement("span",{className:lt},Bt(i,n,a))))}),i&&Ge.a.createElement("button",{className:ot,onClick:i,title:Nt.t,"aria-label":Nt.t},Ge.a.createElement(ut,{size:"Large"}),Ge.a.createElement("div",{className:st},Ge.a.createElement("span",{className:ct},Nt.t))));var e},directionalHint:Ke.DirectionalHint.bottomCenter,calloutProps:{isBeakVisible:!0}},instantOpenOnClick:!0,type:mt.plain,tabIndex:0},Ge.a.createElement("div",{className:"c_a_6bb4a585","data-automation-id":"CommandBarPresenceOverflowCoin"},Ge.a.createElement(it,{overflowPresenceListLength:t.length-3})))}function Kt(e){const{presences:t,webPartDataCollection:n,serviceScope:a,onShareButtonClick:i}=e,r=t.slice(0,3).map((e,t)=>Ge.a.createElement(zt,{key:t,presence:e,webPartDataCollection:n,serviceScope:a})),o=t.length>3;return o&&r.push(Ge.a.createElement(Gt,{key:"CommandBarPresenceOverflowDetailsHoverCard",presences:t,webPartDataCollection:n,serviceScope:a,onShareButtonClick:i})),Ge.a.createElement("div",{className:"a_a_6bb4a585"},Ge.a.createElement("div",{className:"b_a_6bb4a585","data-automation-id":"CommandBarPresences"},r,!o&&i&&Ge.a.createElement(ut,{size:"Small",onClick:i})))}const Wt=m.Guid.newGuid().toString();function qt(){return Wt}const Qt=a._LogSource.create("PresenceManager");class Yt{constructor(e,t){this._broadcastManager=e,this._runtime=t,this._remotePresences=new Map,this._listeners=new Set,this._localPresence={type:"ACTIVE"},this._index=0,this._colorMap={},this.subscribe=e=>(this._listeners.add(e),()=>this._listeners.delete(e)),this._broadcastMessage=e=>{try{const t=this._getPresenceToBroadcast(e);if(t)return this._broadcastManager.broadcastMessage(Fe.UpdatePresence,t)}catch(e){a._TraceLogger.logError(Qt,e),new a._QosMonitor("CoAuth.BroadcastPresenceError").writeUnexpectedFailure(void 0,e)}return!1},this._getPresenceToBroadcast=e=>{if(!this._localPresence)return;const t=Boolean(this._localPresence.isEditAction&&this._lastLocalPresenceTime&&(new Date).getTime()-this._lastLocalPresenceTime.getTime()<15e3);return{data:Object.assign(Object.assign({},this._localPresence),t?{isEditAction:!0}:{}),isRebroadcast:e}},this._handleUpdatePresence=e=>{try{const{from:t,body:n}=e,{clientId:a}=t,i=this._remotePresences.get(a);if(Object(o.isEqual)(i,n))return;const r=i&&n.isRebroadcast?i.receivedTime:new Date,s=i&&Object(o.isEqual)(i.data,n.data)?i.startTime:new Date,c=(null==i?void 0:i.joinTime)||new Date,d=Object.assign(Object.assign({},n),{color:Ve(i,this._colorMap),receivedTime:r,startTime:s,joinTime:c,author:t});this._remotePresences.set(a,d),this._emitPresenceUpdate()}catch(e){a._TraceLogger.logError(Qt,e)}},this._handleAddMember=(e,t)=>{t.details.capabilities.interactive&&t.details.device!==qt()&&this._broadcastMessage(!0),this._crossCompareAudience()&&this._emitPresenceUpdate()},this._handleRemoveMember=e=>{this._remotePresences.delete(e),this._crossCompareAudience(),this._emitPresenceUpdate()},this._crossCompareAudience=()=>{const e=this._runtime.getAudience().getMembers();let t=!1;return this._remotePresences.forEach((n,a)=>{e.has(a)||(this._remotePresences.delete(a),t=!0)}),t},this._emitPresenceUpdate=()=>{this._listeners.forEach(e=>{try{e(this._sortedRemotePresences)}catch(e){a._TraceLogger.logError(Qt,e)}})},this._trySendInitialPresence=()=>{this._runtime.connected&&this._broadcastMessage(!1)||this._runtime.on("connected",()=>{if(!this._broadcastMessage(!1)){const e=new Error("Cannot broadcast the initial presence");a._TraceLogger.logError(Qt,e),new a._QosMonitor("CoAuth.PresenceManager.BroadcastInitialPresence").writeUnexpectedFailure(void 0,e)}})},e.addBroadcastListener(Fe.UpdatePresence,this._handleUpdatePresence),t.getAudience().on("addMember",this._handleAddMember),t.getAudience().on("removeMember",this._handleRemoveMember),je(this._colorMap),this._trySendInitialPresence()}get localPresence(){return this._localPresence}get currentIndex(){return this._index}setLocalPresence(e){return this._localPresence=e||{type:"ACTIVE"},this._lastLocalPresenceTime=new Date,this._index++,this._broadcastMessage(!1),this._index}getRemotePresences(){return Array.from(this._remotePresences.values())}get _sortedRemotePresences(){return Array.from(this._remotePresences.values()).sort(Rt)}}function Jt(e,t){const[n,a]=ze.useState([]),i=ze.useCallback(e=>{Object(o.isEqual)(e,n)||a(e)},[n,a]),r=ze.useRef(void 0);return r.current=i,ze.useEffect(()=>null==e?void 0:e.subscribe(e=>r.current(e.filter(t))),[e]),n}class Xt{constructor(e,t){this._runtime=e,this._context=t,this._broadcastManager=new Ue(t,e)}static load(e,t,n,a){return Object(v.__awaiter)(this,void 0,void 0,function*(){m.Validate.isNotNullOrUndefined(e,"runtime");const i=new Xt(e,t);return yield i.initialize(n,()=>a(e)).then(()=>i),i})}get IFluidRouter(){return this}get root(){return this._root}get agentScheduler(){return this._agentScheduler}get undoRedoStackManager(){return this._undoRedoStackManager}get runtime(){return this._runtime}get broadcastManager(){return this._broadcastManager}request(e){return Promise.resolve({mimeType:"fluid/object",status:200,value:this})}initialize(e,t){return Object(v.__awaiter)(this,void 0,void 0,function*(){if(e)this._root=yield this._runtime.getChannel("root");else{const{rootDDS:e}=t();this._root=e}const n=this._root.get(ke.AgentScheduler);if(n)this._agentScheduler=yield n.get();else{const e=yield Object(H.e)().AgentSchedulerFactory.createChildInstance(this._context);this._root.set(ke.AgentScheduler,e.handle),this._agentScheduler=e}e||this._root.bindToContext(),yield this._initializeUndoRedoStackManager()})}_initializeUndoRedoStackManager(){return Object(v.__awaiter)(this,void 0,void 0,function*(){this._undoRedoStackManager=new f;const e=yield this._root.get(ke.CoreAuthoring);if(e){const t=yield e.get();new(Object(H.e)().SharedTreeUndoRedoHandler)(this._undoRedoStackManager).attachTree(t)}else P("NoSharedTreeInstance",new Error("Data is corrupted, cannot find SharedTree instance"))})}}class Zt{constructor(e){this._fluidDataInitializer=e,this.type=Zt.type,this._dataStoreRegistry=new Map([[this.type,Promise.resolve(this)],Object(H.e)().AgentSchedulerFactory.registryEntry])}get IRuntimeFactory(){return this}get IFluidDataStoreFactory(){return this}get IFluidDataStoreRegistry(){return new(Object(H.e)().FluidDataStoreRegistry)(this._dataStoreRegistry)}instantiateDataStore(e,t){m.Validate.isNotNullOrUndefined(e,"context");const n=new(Object(H.e)().mixinRequestHandler(e=>Object(v.__awaiter)(this,void 0,void 0,function*(){return(yield a).request(e)})))(e,new Map([Object(H.e)().SharedDirectory.getFactory(),Object(H.e)().SharedMap.getFactory(),Object(H.e)().SharedTree.getFactory(Object(H.e)().WriteFormat.v0_0_2)].map(e=>[e.type,e])),t),a=Xt.load(n,e,t,this._fluidDataInitializer);return Promise.resolve(n)}instantiateRuntime(e,t){return Object(v.__awaiter)(this,void 0,void 0,function*(){m.Validate.isNotNullOrUndefined(e,"context");const n=yield Object(H.e)().ContainerRuntime.load(e,this._dataStoreRegistry,Object(H.e)().buildRuntimeRequestHandler(Object(H.e)().defaultRouteRequestHandler(this.type),Object(H.e)().rootDataStoreRequestHandler));if(!t){const e=yield n.createDataStore(this.type);yield e.trySetAlias(this.type)}return n})}}Zt.type="default";var $t=n("vlQI"),en=n("2SXB");function tn(e){if(!m.Guid.tryParse(e))throw new Error("InvalidGuid");const t=new Uint8Array(16);let n,a=0;const i=Number(`0x${e.substr(a,8)}`);t[0]=i,t[1]=i>>8,t[2]=i>>16,t[3]=i>>24,a+=9;const r=Number(`0x${e.substr(a,4)}`);t[4]=r,t[5]=r>>8,a+=5;const o=Number(`0x${e.substr(a,4)}`);t[6]=o,t[7]=o>>8,a+=5,n=Number(`0x${e.substr(a,4)}`),a+=5;const s=Number(`0x${e.substr(a)}`);return t[8]=n>>8,t[9]=n,n=Math.floor(s/4294967296),t[10]=n>>8,t[11]=n,n=s,t[12]=n>>24,t[13]=n>>16,t[14]=n>>8,t[15]=n,t}class nn{constructor(e){this._pageContext=e.consume(At.PageContext.serviceKey)}static findLocation(e){return Object(v.__awaiter)(this,void 0,void 0,function*(){m.Validate.isNotNullOrUndefined(e,"serviceScope");const t=new nn(e),n=t._getDriveId(),a=yield t._getItemId(e);return{siteUrl:t._siteUrl,driveId:n,itemId:a}})}get _siteUrl(){return this._pageContext.site.absoluteUrl}_getDriveId(){const e=this._pageContext.web.id,t=this._pageContext.site.id;return function(e,t,n){m.Validate.isNotNullOrUndefined(e,"listId"),m.Validate.isNotNullOrUndefined(t,"webId"),m.Validate.isNotNullOrUndefined(n,"siteId");const a=e=>e instanceof m.Guid?e:m.Guid.tryParse(e);return function(e,t,n){const a=new Uint8Array(48),i=tn(e.toString()),r=tn(t.toString()),o=tn(n.toString());return a.set(i),a.set(r,16),a.set(o,32),"b!"+function(e){let t=function(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return window.btoa(t)}(e);return t=t.split("=")[0],t=t.replace(/\+/g,"-"),t=t.replace(/\//g,"_"),t}(a)}(a(n),a(t),a(e))}(this._pageContext.list.id,e,t)}_getItemId(e){var t,n;return Object(v.__awaiter)(this,void 0,void 0,function*(){const i=null===(t=this._pageContext.listItem)||void 0===t?void 0:t.uniqueId;if(i)return Promise.resolve(i);const r=new a._QosMonitor("CoAuth.MissingListItemUniqueId"),o=(null===(n=this._pageContext.listItem)||void 0===n?void 0:n.id)||this._pageContext.legacyPageContext.pageItemId,s=this._pageContext.web.absoluteUrl;if(!o){const e=new Error("Page ID MUST exist in page context");return r.writeUnexpectedFailure("MissingPageId",e),Promise.reject(e)}return Lt.SPComponentLoader.loadComponentById("1cea229f-b208-4202-8014-22503d92a019").then(t=>{const n=e.consume(en.SPHttpClient.serviceKey);return new t.PageDataSource({spHttpClient:n,pageContext:this._pageContext}).getPageJsonBlobById(s,o,void 0,"/UniqueId").then(e=>{var t;if(null===(t=e[0])||void 0===t?void 0:t.value)return r.writeSuccess(),e[0].value;throw r.writeUnexpectedFailure("FailedFetchingUniqueId"),new Error("Failed fetching UniqueId.")})}).catch(e=>{throw r.writeUnexpectedFailure(void 0,e),e})})}}class an{constructor(e){this._isDisposed=!1,this.dispose=()=>{this._coreSharedTreeManager.dispose(),this._isDisposed=!0},this._handleDataChanged=e=>{this._pageLifeCycleManager.notifyPageDirty(e)};const{rootDirectory:t,pageLifeCycleManager:n}=e,a=Object(v.__rest)(e,["rootDirectory","pageLifeCycleManager"]);this._pageLifeCycleManager=n,this._metadataManager=new Pe({rootDirectory:t,onDataChanged:this._handleDataChanged}),this._coreSharedTreeManager=new Ee(Object.assign(Object.assign({},a),{onDataChanged:this._handleDataChanged}))}get metadata(){return this._metadataManager}get core(){return this._coreSharedTreeManager}get isDisposed(){return this._isDisposed}}function rn(e,t){const n=Object(H.e)().SharedDirectory.create(e,"root"),a=n.createSubDirectory(ke.Metadata);return a.set(Me.IsDefaultDescription,t.isDefaultDescription),a.set(Me.PageDescription,t.pageDescription),a.set(Me.IsDefaultThumbnail,t.isDefaultThumbnail),a.set(Me.PageThumbnail,t.pageThumbnail),a.set(Me.IsSpellCheckEnabled,t.isSpellCheckEnabled),a.set(Me.IsRecommendedItemsEnabled,t.isRecommendedItemsEnabled),a.set(Me.IsCommentSectionEnabled,t.isCommentSectionEnabled),n.set(ke.CoreAuthoring,function(e){const{runtime:t,canvasContent:n,lockedWebParts:a}=e,r=Object(H.e)().SharedTree.create(t,"canvasRoot"),o={traits:{[b.canvasRoot]:[V(n)],[b.lockedWebPartsRoot]:[(s=a||new Map,{traits:{[b.lockedWebParts]:s.map(me).filter(i.isDefined)},definition:h.lockedWebPartsRoot})]},definition:h.documentRoot};var s;const c={parent:r.convertToNodeId(Object(H.e)().initialTree.identifier),label:b.documentRoot};return r.applyEdit(...Object(H.e)().setTrait(c,[o])),r.handle}({runtime:e,canvasContent:t.canvasContent,lockedWebParts:on(t.layoutWebPartContentMap)})),{rootDDS:n}}function on(e){const t=[];return null==e||e.forEach((e,n)=>{const{reservedHeight:a}=e,i=Object(v.__rest)(e,["reservedHeight"]);t.push({instanceId:n,reservedSize:{reservedHeight:a},webPartData:i})}),t}var sn;!function(e){e.v1_0="1.0"}(sn||(sn={}));const cn={[sn.v1_0]:{package:"no-dynamic-package",config:{version:"1.0"}}};function dn(e){return cn[e]}function ln(){return sn.v1_0}function un(e){var t;return(null===(t=e.config)||void 0===t?void 0:t.version)||"1.0"}function fn(e){return Number(un(e))}function pn(e){return Math.trunc(fn(e))}class mn{constructor(e){this._initialPageData=e,this.IFluidCodeDetailsComparer={get IFluidCodeDetailsComparer(){return this},satisfies:(e,t)=>Object(v.__awaiter)(this,void 0,void 0,function*(){const n=pn(e),a=pn(t),i=pn(dn(ln()));return n===a&&n===i}),compare:(e,t)=>Object(v.__awaiter)(this,void 0,void 0,function*(){return fn(e)-fn(t)})}}load(e){return Object(v.__awaiter)(this,void 0,void 0,function*(){if("1.0"===un(e))return{module:{fluidExport:new Zt(e=>rn(e,this._initialPageData))},details:dn(sn.v1_0)};throw new Error("Unknown code version")})}}class _n{constructor(e,t){var n;this._serviceScope=e,this._initialPageData=t,this._logger=(n=this._serviceScope,new class extends Object(H.e)().TelemetryLogger{constructor(e){super(),this._serviceScope=e,this.supportsTags=!0,this._shouldCaptureError=!1,this.notifyContainerLoaded=()=>{this._shouldCaptureError=!0,T.instance.addLog("Container is loaded. Start capturing container errors.")}}send(e){const t=JSON.stringify(e);T.instance.addLog(t),this._shouldCaptureError&&"error"===e.category&&new a._QosMonitorShareFailureWithCP("CoAuth.FluidRuntimeError",!1,[{errorModuleName:"PagesCoAuth Fluid Failure",logFailure:this._serviceScope.consume(Oe._EditModeCustomerPromiseHandler.serviceKey).logFailure}]).writeUnexpectedFailure(void 0,new Error(e.eventName),{payload:t})}}(n)),this._isSafari=m._BrowserUtilities.isSafari(),this._tryFetchPushChannelToken=(e,t,n)=>Object(v.__awaiter)(this,void 0,void 0,function*(){return e._getTokenInternal("https://pushchannel.1drv.ms",t,n)}),m.Validate.isNotNullOrUndefined(e,"serviceScope"),m.Validate.isNotNullOrUndefined(t,"initialPageData"),e.whenFinished(()=>{this._pageContext=e.consume(At.PageContext.serviceKey),this._tokenProviderFactory=e.consume($t.AadTokenProviderFactory.serviceKey)})}static getContainer(e,t,n){return new _n(e,t).getContainer(n)}getContainer(e){return Object(v.__awaiter)(this,void 0,void 0,function*(){const t=new a._QosMonitorShareFailureWithCP("CoAuth.GetFluidContainer",!1,[{errorModuleName:"ContainerClosedUnexpectedly",logFailure:this._serviceScope.consume(Oe._EditModeCustomerPromiseHandler.serviceKey).logFailure}]);try{const[n,a]=yield Promise.all([this._createLoader(),nn.findLocation(this._serviceScope)]);let i;if(e)i=yield this._createNewContainer(n,a);else try{i=yield this._getExistingContainer(n,a)}catch(e){i=yield this._createNewContainer(n,a)}return this._logger.notifyContainerLoaded(),ae()||i.connect(),t.writeSuccess(),i}catch(e){if(this._interceptErrorHandling){const n=this._interceptErrorHandling();throw n.extraData&&(n.extraData.caughtError=e.message),Object(i.writeFailureToMonitor)(n,t),n}throw e}})}_createDocumentServiceFactory(){const{aadInstanceUrl:e,aadSessionId:t,aadUserId:a,aadTenantId:i,userPrincipalName:r}=this._pageContext.legacyPageContext,o={aadInstanceUrl:e,aadSessionId:t,aadTenantId:i,aadUserId:a,redirectUri:window.location.origin+"/_forms/"+en._AadConstants.SPFX_SINGLE_SIGN_ON_REPLY_URL,servicePrincipalId:en._AadConstants.PRE_AUTHORIZED_APP_PRINCIPAL_ID,userPrincipalName:r};return this._tokenProviderFactory.getTokenProvider().then(e=>{return t=new(Object(H.e)().OdspDocumentServiceFactory)(t=>{const n=new URL(t.siteUrl);this._fetchPushTokenPromise||(this._fetchPushTokenPromise=this._tryFetchPushChannelToken(e,o,!t.refresh));const a=e._getTokenInternal(n.origin,o,!t.refresh).catch(e=>{throw this._checkTokenFetchError(t,e),e});return this._isSafari?Promise.all([a,this._fetchPushTokenPromise]).then(([e])=>e):a},t=>(this._fetchPushTokenPromise||(this._fetchPushTokenPromise=this._tryFetchPushChannelToken(e,o,!t.refresh)),this._fetchPushTokenPromise.catch(e=>{throw this._checkTokenFetchError(t,e),this._fetchPushTokenPromise=void 0,e}))),M()&&"true"===new URL(location.toString()).searchParams.get("fluidDebugger")?(localStorage.FluidDebugger=1,n.e(0).then(n.bind(null,"ZliV")).then(e=>e._debuggerWrapper(t))):(delete localStorage.FluidDebugger,t);var t})}_createLoader(){return this._createDocumentServiceFactory().then(e=>new(Object(H.e)().Loader)({urlResolver:new(Object(H.e)().OdspDriverUrlResolver),documentServiceFactory:e,codeLoader:oe()?{load:()=>Promise.resolve({module:{fluidExport:new Zt(e=>rn(e,this._initialPageData))},details:{package:"SpPagesFluid"}})}:new mn(this._initialPageData),logger:this._logger}))}_createNewContainer(e,t){return Object(v.__awaiter)(this,void 0,void 0,function*(){e.services.clientDetailsOverride={device:qt()};const n=yield e.createDetachedContainer(oe()?{package:"no-dynamic-package",config:{}}:dn(ln()));yield Object(H.e)().getDefaultObjectFromContainer(n);try{yield n.attach(this._getRequest(t))}catch(n){const i=new a._QosMonitor("CoAuth.RefetchContainerCreatedByOthers");try{const n=yield this._getExistingContainer(e,t,!1);return i.writeSuccess(),n}catch(e){throw i.writeUnexpectedFailure(void 0,n),e}}return n})}_getExistingContainer(e,t,n=!0){return e.resolve(this._getRequest(t,n))}_getRequest(e,t=!0){return{url:Object(H.e)().createOdspUrl({siteUrl:e.siteUrl,driveId:e.driveId,itemId:e.itemId,dataStorePath:"/"}),headers:{[Object(H.e)().LoaderHeader.cache]:t,[Object(H.e)().LoaderHeader.loadMode]:ae()?void 0:{deltaConnection:"none"},[Object(H.e)().LoaderHeader.clientDetails]:{device:qt()}}}}_checkTokenFetchError(e,t){var n;if(!this._interceptErrorHandling){const a=[en._AadConstants.LOGIN_REQUIRED,"Token request previously failed"],r=null===(n=e.previousError)||void 0===n?void 0:n.errorMessage,o={options:JSON.stringify(e)};let s=!1;if(a.some(e=>{const n=r&&r.indexOf(e)>-1||t.message.indexOf(e)>-1;return e===en._AadConstants.LOGIN_REQUIRED&&(s=!0),n}))return void(this._interceptErrorHandling=()=>new i.ExpectedFailure(s?"LoginRequired":"KnownTokenFetchError",t,o));this._interceptErrorHandling=()=>new i.UnexpectedFailure("UnknownTokenFetchError",t,o)}}}function hn(e){return void 0!==e&&"string"!=typeof e}var bn=n("EMNu");const gn=a._LogSource.create("PageStatusTracker"),vn=-1;class yn{constructor(e){this._options=e,this._isDisposed=!1,this._myLastClientSequenceNumberSent=vn,this._myLastClientSequenceNumberReceived=vn,this._myLastSessionSequenceNumberReceived=vn,this._lastSessionSequenceNumberReceived=vn,this._savedSessionSequenceNumber=vn,this._savingSessionSequenceNumber=vn,this._myLastDirtySequenceNumberReceived=vn,this._myLastDirtyClientSequenceNumberSent=vn,this._mySavingClientSequenceNumber=vn,this._mySavedClientSequenceNumber=vn,this._hasPendingLocalChanges=!1,this._mostRecentVersionTimeStamp=0,this._currentAction="None",this._currentChangesState="None",this._currentActedBy=void 0,this.onPageDirty=e=>{this._myLastDirtyClientSequenceNumberSent=this._myLastClientSequenceNumberSent,this._myLastDirtySequenceNumberReceived=this._myLastSessionSequenceNumberReceived,e&&(this._hasPendingLocalChanges=!0),this._updatePageStatus()},this.onStartSave=()=>{this._savingSessionSequenceNumber=this._lastSessionSequenceNumberReceived,this._mySavingClientSequenceNumber=this._myLastDirtyClientSequenceNumberSent,this._updatePageStatus("SaveStarted",void 0),this._options.broadcastManager.broadcastMessage(Fe.PageStatus,{type:"SaveStarted",savingSessionSequenceNumber:this._savingSessionSequenceNumber}),this._hasPendingLocalChanges=!1},this.onSaveSucceed=e=>{this._savedSessionSequenceNumber=this._savingSessionSequenceNumber,this._mySavedClientSequenceNumber=this._mySavingClientSequenceNumber,this._mySavingClientSequenceNumber=vn,this._savingSessionSequenceNumber=vn,this._updatePageStatus("SaveCompleted",void 0),this._options.broadcastManager.broadcastMessage(Fe.PageStatus,{type:"SaveCompleted",savedSessionSequenceNumber:this._savedSessionSequenceNumber,savedAsNewVersion:e}),e&&(this.setShouldSaveAsNewVersionOnNextChange(!1),this._mostRecentVersionTimeStamp=Date.now())},this.onSaveFailed=e=>{this._savingSessionSequenceNumber=vn,this._mySavingClientSequenceNumber=vn;const t={type:"SaveFailed",error:e};this._updatePageStatus(t,void 0),this._options.broadcastManager.broadcastMessage(Fe.PageStatus,{type:"Failed",error:t})},this.onStartPublish=()=>{this._savingSessionSequenceNumber=this._lastSessionSequenceNumberReceived,this._updatePageStatus("PublishStarted",void 0),this._options.broadcastManager.broadcastMessage(Fe.PageStatus,{type:"PublishStarted",publishingSessionSequenceNumber:this._savingSessionSequenceNumber})},this.onPublishFailed=e=>{this._savingSessionSequenceNumber=vn;const t={type:"PublishFailed",error:e};this._updatePageStatus(t,void 0),this._options.broadcastManager.broadcastMessage(Fe.PageStatus,{type:"Failed",error:t})},this.onPublishSucceed=()=>{this._savedSessionSequenceNumber=this._savingSessionSequenceNumber,this._savingSessionSequenceNumber=vn,this._updatePageStatus("PublishCompleted",void 0),this._options.broadcastManager.broadcastMessage(Fe.PageStatus,{type:"PublishCompleted",publishedSessionSequenceNumber:this._savedSessionSequenceNumber})},this.onPageIdled=()=>{this._options.broadcastManager.broadcastMessage(Fe.PageStatus,{type:"ShouldSaveAsNewVersionOnNextChange"})},this._handleBroadcast=e=>{if(this._isDisposed)return;const{body:t,from:n}=e;switch(t.type){case"SaveStarted":this._savingSessionSequenceNumber=t.savingSessionSequenceNumber,this._updatePageStatus("SaveStarted",n);break;case"SaveCompleted":this._savedSessionSequenceNumber=t.savedSessionSequenceNumber,this._savingSessionSequenceNumber=vn,t.savedAsNewVersion&&(this.setShouldSaveAsNewVersionOnNextChange(!1),this._mostRecentVersionTimeStamp=Date.now()),this._updatePageStatus("SaveCompleted",n);break;case"PublishStarted":this._savingSessionSequenceNumber=t.publishingSessionSequenceNumber,this._updatePageStatus("PublishStarted",n);break;case"PublishCompleted":this._savedSessionSequenceNumber=t.publishedSessionSequenceNumber,this._savingSessionSequenceNumber=vn,this._updatePageStatus("PublishCompleted",n);break;case"Failed":this._savingSessionSequenceNumber=vn,this._updatePageStatus(t.error,n);break;case"ShouldSaveAsNewVersionOnNextChange":this.setShouldSaveAsNewVersionOnNextChange(!0)}},this._updatePageStatus=(e=this._currentAction,t=this._currentActedBy)=>{try{const n=this._getChangesState();if(n===this._currentChangesState&&e===this._currentAction&&Object(o.isEqual)(t,this._currentActedBy))return;this._currentAction=e,this._currentChangesState=n,this._currentActedBy=t,this._options.onPageStatusChanged({lastLifeCycleEvent:this._currentAction,changesState:this._currentChangesState,from:t})}catch(e){a._TraceLogger.logError(gn,e),new a._QosMonitor("CoAuth.UpdatePageStatusError").writeUnexpectedFailure(void 0,e)}},this._getChangesState=()=>{if(this._hasPendingLocalChanges)return"NotSaved";if(this._myLastDirtyClientSequenceNumberSent===vn)return"None";if(this.areAllMyChangesSaved)return"Saved";if(this._myLastClientSequenceNumberSent<this._myLastClientSequenceNumberReceived)throw new Error("Sequenced op has larger clientSequenceNumber than local");return"NotSaved"},this._setSaveAsNewVersionOnNextChange=()=>{this.setShouldSaveAsNewVersionOnNextChange(!0)},this._haveMinimumSaveIntervalPassed=()=>Date.now()-this.mostRecentVersionTimeStamp>=6e4,this._handleBeforeUnload=e=>(this.areAllMyChangesSaved||(e.preventDefault(),e.returnValue=bn.e),e.returnValue);const{broadcastManager:t,runtime:n,shouldFirstSaveBumpVersion:i}=e;this._shouldSaveAsNewVersionOnNextChange=i||!1,t.addBroadcastListener(Fe.PageStatus,this._handleBroadcast),n.getAudience().on("addMember",this._setSaveAsNewVersionOnNextChange),n.getAudience().on("removeMember",this._setSaveAsNewVersionOnNextChange),window.addEventListener("beforeunload",this._handleBeforeUnload)}onMyOpReceived({clientSequenceNumber:e,sessionSequenceNumber:t}){this._myLastClientSequenceNumberReceived=e,this._myLastSessionSequenceNumberReceived=t,e<=this._myLastDirtyClientSequenceNumberSent&&(this._myLastDirtySequenceNumberReceived=t),this._hasPendingLocalChanges=!1,this._updatePageStatus()}set myLastClientSequenceNumberSent(e){this._myLastClientSequenceNumberSent=e,this._hasPendingLocalChanges&&(this._myLastDirtyClientSequenceNumberSent=e,this._hasPendingLocalChanges=!1),this._updatePageStatus()}set lastSessionSequenceNumberReceived(e){this._lastSessionSequenceNumberReceived=e}get mostRecentVersionTimeStamp(){return this._mostRecentVersionTimeStamp}get areAllMyChangesSaved(){const e=this._mySavedClientSequenceNumber>=this._myLastDirtyClientSequenceNumberSent,t=this._myLastClientSequenceNumberReceived>=this._myLastDirtyClientSequenceNumberSent&&this._savedSessionSequenceNumber>=this._myLastDirtySequenceNumberReceived;return!this._hasPendingLocalChanges&&(e||t)}setShouldSaveAsNewVersionOnNextChange(e,t=!1){(!e||t||this._haveMinimumSaveIntervalPassed())&&(this._shouldSaveAsNewVersionOnNextChange=e)}get shouldSaveAsNewVersionOnNextChange(){return this._shouldSaveAsNewVersionOnNextChange}get status(){return{lastLifeCycleEvent:this._currentAction,changesState:this._currentChangesState,from:this._currentActedBy}}dispose(){window.removeEventListener("beforeunload",this._handleBeforeUnload),this._isDisposed=!0}get isDisposed(){return this._isDisposed}}const Sn=a._LogSource.create("AutoSaveTaskScheduler");class Dn{constructor(e,t,n){this._pageStatusTracker=t,this._onAutoSave=n,this._isDisposed=!1,this._isAssignedToAutoSaveTask=!1,this._hasPendingSaveRequest=!1,this.dispose=()=>{this._taskSubscription.off("gotTask",this._handleGotTask),this._taskSubscription.off("lostTask",this._handleLostTask),this._isDisposed=!0},this.triggerAutoSave=()=>{this._canRunTask&&(this._runningTask?this._hasPendingSaveRequest=!0:(this._hasPendingSaveRequest=!1,this._runningTask=this._delayRun(this._pageStatusTracker.shouldSaveAsNewVersionOnNextChange)))},this._handleGotTask=()=>{this._isAssignedToAutoSaveTask=!0,this.triggerAutoSave()},this._handleLostTask=()=>{this._isAssignedToAutoSaveTask=!1},this._delayRun=e=>Object(v.__awaiter)(this,void 0,void 0,function*(){if(a._TraceLogger.logVerbose(Sn,"Auto save will start in 5 seconds"),yield new Promise(e=>{window.setTimeout(e,5e3)}),this._canRunTask){this._hasPendingSaveRequest=!1;try{yield this._onAutoSave(e),a._TraceLogger.logVerbose(Sn,"Auto save completed")}catch(e){a._TraceLogger.logError(Sn,e)}this._hasPendingSaveRequest?(this._hasPendingSaveRequest=!1,this._runningTask=this._delayRun(!1)):this._runningTask=void 0}}),this._taskSubscription=new(Object(H.e)().TaskSubscription)(e,"AUTO_SAVE_TASK"),this._taskSubscription.volunteer(),this._taskSubscription.on("gotTask",this._handleGotTask),this._taskSubscription.on("lostTask",this._handleLostTask)}get isDisposed(){return this._isDisposed}get isAssignedToAutoSaveTask(){return this._isAssignedToAutoSaveTask}get _canRunTask(){return!this._isDisposed&&this._isAssignedToAutoSaveTask}}class In{constructor(e){this._options=e,this._isDisposed=!1,this.dispose=()=>{this._autoSaveTaskScheduler.dispose(),this._isDisposed=!0},this.notifyPageDirty=()=>{const{pageStatusTracker:e}=this._options;this._autoSaveTaskScheduler.triggerAutoSave(),this._autoSaveTaskScheduler.isAssignedToAutoSaveTask&&!e.shouldSaveAsNewVersionOnNextChange&&(window.clearTimeout(this._pageIdleTimer||void 0),this._pageIdleTimer=window.setTimeout(()=>{e.setShouldSaveAsNewVersionOnNextChange(!0),e.onPageIdled()},12e4))},this.save=()=>Object(v.__awaiter)(this,void 0,void 0,function*(){const{pageStatusTracker:e,userClientCounter:t}=this._options;return re()?yield this._saveCore({shouldSaveAsNewVersion:e.shouldSaveAsNewVersionOnNextChange,lockAction:{type:t.getClientCount()>1?1:2},isAutoSave:!1}):m._SPKillSwitch.isActivated("b9fe1246-1798-4a98-a97c-af8a9a65eadf")&&e.areAllMyChangesSaved||(yield i.RetryHelper.retryV2({maxRetryTimes:3,componentName:"CoAuthSaver",scenarioName:"Save",action:()=>this._saveCore({shouldSaveAsNewVersion:e.shouldSaveAsNewVersionOnNextChange,lockAction:{type:t.getClientCount()>1?1:2},isAutoSave:!1}),shouldRetryOnError:e=>!1!==e.isRetriable})),e.status}),this._autoSaveWithRetry=e=>Object(v.__awaiter)(this,void 0,void 0,function*(){if(re())try{yield this._autoSave(e)}catch(t){if(!1===t.isRetriable)throw this._options.onSaveFailedConsistently(t),t;const n=new a._QosMonitorShareFailureWithCP("CoAuth.AutoSaveRetry",!1,[{errorModuleName:"RetryFailed",logFailure:this._options.serviceScope.consume(Oe._EditModeCustomerPromiseHandler.serviceKey).logFailure}]);return new Promise((t,a)=>{window.setTimeout(()=>{this._autoSave(e).then(()=>{n.writeSuccess(),t()}).catch(e=>{n.writeUnexpectedFailure(void 0,e),this._options.onSaveFailedConsistently(e),a(e)})},2e3)})}else try{yield i.RetryHelper.retryV2({maxRetryTimes:3,componentName:"CoAuthSaver",scenarioName:"AutoSave",action:()=>this._autoSave(e),shouldRetryOnError:e=>!1!==e.isRetriable,waitTimeInMs:2e3})}catch(e){throw new a._QosMonitorShareFailureWithCP("CoAuth.SaveRetryError",!1,[{errorModuleName:"RetryFailed",logFailure:this._options.serviceScope.consume(Oe._EditModeCustomerPromiseHandler.serviceKey).logFailure}]).writeUnexpectedFailure(void 0,e),this._options.onSaveFailedConsistently(e),e}}),this._autoSave=e=>Object(v.__awaiter)(this,void 0,void 0,function*(){return this._saveCore({shouldSaveAsNewVersion:e,lockAction:{type:1},isAutoSave:!0})}),this._saveCore=e=>Object(v.__awaiter)(this,void 0,void 0,function*(){this._lockRefreshTimer&&(re()||1===e.lockAction.type)&&window.clearTimeout(this._lockRefreshTimer);const{saveImpl:t,pageStatusTracker:n}=this._options,{shouldSaveAsNewVersion:a}=e;n.onStartSave(),a&&window.clearTimeout(this._pageIdleTimer||void 0);try{yield t(e),n.onSaveSucceed(a),this._lockRefreshTimer=window.setTimeout(this.notifyPageDirty,15e5)}catch(e){throw n.onSaveFailed(e),e}});const{agentScheduler:t}=e;this._autoSaveTaskScheduler=new Dn(t,e.pageStatusTracker,this._autoSaveWithRetry)}get isDisposed(){return this._isDisposed}}class xn{constructor(e){this._options=e,this._isDisposed=!1,this.saveAndPublish=()=>Object(v.__awaiter)(this,void 0,void 0,function*(){const{saveAndPublishImpl:e,pageStatusTracker:t,userClientCounter:n}=this._options;t.onStartPublish();try{t.setShouldSaveAsNewVersionOnNextChange(!0,!0),re()?yield e({lockAction:{type:n.getClientCount()>1?0:2}}):yield i.RetryHelper.retryV2({maxRetryTimes:3,componentName:"CoAuthPublisher",scenarioName:"SaveAndPublish",action:()=>e({lockAction:{type:n.getClientCount()>1?0:2}}),shouldRetryOnError:e=>!1!==e.isRetriable}),a._EngagementLogger.logEventWithLogEntry(new a._LogEntry("CoAuth.Publish","Click",a._LogType.Event,{usersCount:String(n.getUserCount())})),t.onPublishSucceed()}catch(e){throw t.onPublishFailed(e),e}return t.status}),this.dispose=()=>{this._isDisposed=!0}}get isDisposed(){return this._isDisposed}}class Cn{constructor(e){this._options=e,this._isDisposed=!1,this._eventEmitter=new r.EventEmitter,this._hasPageBeenDirty=!1,this.on=(e,t)=>(this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)),this.saveAndPublish=()=>this._publisher.saveAndPublish(),this.save=()=>this._saver.save(),this.notifyPageDirty=e=>{this._saver.notifyPageDirty(),this._changeStatusTracker.onPageDirty(e),this._hasPageBeenDirty=!0},this.dispose=()=>{this._unsubscribeDeltaManager(),this._changeStatusTracker.dispose(),this._eventEmitter.removeAllListeners(),this._saver.dispose(),this._publisher.dispose(),this._isDisposed=!0},this._onPageStatusUpdated=e=>{this._eventEmitter.emit("pageStatusChanged",e)},this._setUpDeltaManagerEvents=()=>{const{deltaManager:e}=this._options;return e.on("submitOp",this._handleSubmitOp),e.on("op",this._handleOpProcessed),e.on("connect",this._handleConnect),()=>{e.off("submitOp",this._handleSubmitOp),e.off("op",this._handleOpProcessed),e.off("connect",this._handleConnect)}},this._handleSubmitOp=e=>{e.type===Object(H.e)().MessageType.Operation&&(this._changeStatusTracker.myLastClientSequenceNumberSent=e.clientSequenceNumber)},this._handleOpProcessed=e=>{e.type===Object(H.e)().MessageType.Operation&&(this._changeStatusTracker.lastSessionSequenceNumberReceived=e.sequenceNumber,e.clientId===this._clientId&&this._changeStatusTracker.onMyOpReceived({clientSequenceNumber:e.clientSequenceNumber,sessionSequenceNumber:e.sequenceNumber}),a._Diagnostics.updateSettings({extraDiagnosticInfo:{authoringOpSequenceId:e.sequenceNumber}}))},this._handleConnect=e=>{this._clientId=e.clientId};const{serviceScope:t,agentScheduler:n,broadcastManager:i,pageLifeCycleImplementations:o,initialClientId:s,runtime:c,shouldFirstSaveBumpVersion:d,userClientCounter:l,onSaveFailedConsistently:u}=e;this._changeStatusTracker=new yn({onPageStatusChanged:this._onPageStatusUpdated,broadcastManager:i,runtime:c,shouldFirstSaveBumpVersion:d});const{saveImpl:f,saveAndPublishImpl:p}=o;this._saver=new In({serviceScope:t,agentScheduler:n,saveImpl:f,pageStatusTracker:this._changeStatusTracker,userClientCounter:l,onSaveFailedConsistently:u}),this._publisher=new xn({serviceScope:t,saveAndPublishImpl:p,pageStatusTracker:this._changeStatusTracker,userClientCounter:l}),this._clientId=s,this._unsubscribeDeltaManager=this._setUpDeltaManagerEvents()}get isDisposed(){return this._isDisposed}get areAllMyChangesSaved(){return this._changeStatusTracker.areAllMyChangesSaved}get hasPageBeenDirty(){return this._hasPageBeenDirty}}const On=["click","mousedown","mouseup","keydown","keyup","touchstart","touchend"];class wn{constructor(e){if(this._isDisposed=!1,this._timeouts=[],this._lastInteractionTime=0,this._setInactivityListeners=()=>{window.addEventListener("blur",this._startTimeouts),window.addEventListener("focus",this._handleWindowFocus),On.forEach(e=>{window.addEventListener(e,this._handleUserInteraction,!0)}),this._checkInteractionInterval=window.setInterval(this._checkUserInteractionPeriodically,6e4)},this._clearInactivityListeners=()=>{window.removeEventListener("blur",this._startTimeouts),window.removeEventListener("focus",this._handleWindowFocus),On.forEach(e=>{window.removeEventListener(e,this._handleUserInteraction,!0)}),window.clearInterval(this._checkInteractionInterval)},this._handleWindowFocus=()=>{this._onUserInteract(),this._clearTimeouts()},this._checkUserInteractionPeriodically=()=>{this._lastInteractionTime>0&&(this._clearTimeouts(),this._startTimeoutsWithOffset(performance.now()-this._lastInteractionTime),this._lastInteractionTime=0)},this._handleUserInteraction=()=>{this._lastInteractionTime=performance.now(),this._onUserInteract()},this._startTimeouts=()=>{this._startTimeoutsWithOffset()},this._startTimeoutsWithOffset=(e=0)=>{this._clearTimeouts(),this._timeouts=this._idleMonitors.map(t=>window.setTimeout(t.idleCallback,t.timeoutInMs-e))},this._clearTimeouts=()=>{this._timeouts.length&&(this._timeouts.forEach(e=>{window.clearTimeout(e)}),this._timeouts=[])},this._setInactivityListeners(),this._idleMonitors=e.idleMonitors.sort((e,t)=>e.timeoutInMs-t.timeoutInMs),this._onUserInteract=e.onUserInteract,this._startTimeouts(),!this._idleMonitors||this._idleMonitors[0].timeoutInMs<12e4)throw new Error("Invalid idle monitors.")}dispose(){this._clearInactivityListeners(),this._clearTimeouts(),this._isDisposed=!0}get isDisposed(){return this._isDisposed}}class En{constructor(e){this._options=e,this._isDisposed=!1,this._handlerUserInteract=()=>{var e;this._isDisposed||"INACTIVE"!==(null===(e=this._options.presenceManager.localPresence)||void 0===e?void 0:e.type)||this._options.presenceManager.setLocalPresence({type:"ACTIVE"})},this._enterInactiveState=()=>{this._isDisposed||(a._EngagementLogger.logEvent("CoAuth.UserState.Inactive"),this._options.presenceManager.setLocalPresence({type:"INACTIVE"}))},this._disconnect=()=>{this._isDisposed||(a._EngagementLogger.logEvent("CoAuth.UserState.Disconnected"),this._options.onDisconnect())},this._interactionTracker=new wn({idleMonitors:[{timeoutInMs:3e5,idleCallback:this._enterInactiveState},{timeoutInMs:9e5,idleCallback:this._disconnect}],onUserInteract:this._handlerUserInteract})}dispose(){this._interactionTracker.dispose(),this._isDisposed=!0}get isDisposed(){return this._isDisposed}}const An=a._LogSource.create("UserClientCounter");class Ln{constructor(e){this._runtime=e,this._countTable=[],this.getUserCount=()=>(this._count(),Math.max(...this._countTable.map(({userCount:e})=>e),0)),this.getClientCount=()=>(this._count(),Math.max(...this._countTable.map(({clientCount:e})=>e),0)),this.getCurrentConnectedClientCount=()=>(this._count(),this._countTable.length?this._countTable[this._countTable.length-1].clientCount:0),this._count=(e,t)=>{const n=new Map(this._runtime.getAudience().getMembers());e&&t&&!n.has(e)&&n.set(e,t),this._calcUserClientCount(n)},this._calcUserClientCount=e=>{const t=new Set,n=new Set;e.forEach(e=>{e.details.capabilities.interactive&&(t.has(e.user.id)||t.add(e.user.id),e.details.device?n.has(e.details.device)||n.add(e.details.device):a._TraceLogger.logError(An,new Error("Device id is missing from client details.")))}),this._cleanUpCountTable(),this._countTable.push({timestamp:performance.now(),clientCount:n.size,userCount:t.size})},this._cleanUpCountTable=()=>{if(this._countTable.length){const e=performance.now(),t=this._countTable.findIndex(({timestamp:t},n)=>e-t<1e4);this._countTable.splice(0,t>-1?t:this._countTable.length),0===this._countTable.length&&this._calcUserClientCount(this._runtime.getAudience().getMembers())}},e.getAudience().on("addMember",this._count),e.getAudience().on("removeMember",this._count)}}const kn=a._LogSource.create("PageFluidOrchestrator");class Mn{constructor(e,t,n,i,r,o,s){this._serviceScope=e,this._container=t,this._dependencies=r,this._hasConnectedOnce=!1,this._isDisposeStarted=!1,this._handleContainerClosed=e=>{var t,n;if(se()&&!e)return;const i=new Error(null==e?void 0:e.message),r=new a._QosMonitorShareFailureWithCP("CoAuth.ContainerClosed",!1,[{errorModuleName:"ContainerClosedUnexpectedly",logFailure:this._serviceScope.consume(Oe._EditModeCustomerPromiseHandler.serviceKey).logFailure}]);if(!se()&&!e&&this._isDisposeStarted)return void r.writeSuccess();const o="fileNotFoundOrAccessDeniedError"===(null==e?void 0:e.errorType);if(se())r.writeUnexpectedFailure(void 0,i,{errorInfo:JSON.stringify(e)});else{const t=this.pageLifeCycleManager.hasPageBeenDirty;(o||t?r.writeExpectedFailure:r.writeUnexpectedFailure)(o?"FileNotFoundOrAccessDenied":t?"SessionNotStarted":"Unknown",i,{errorInfo:JSON.stringify(e),isDeltaConnectionActive:this._container.deltaManager.active})}this._reconnectMonitor&&!this._reconnectMonitor.hasEnded&&this._reconnectMonitor.writeExpectedFailure("ContainerClosed",i),null===(n=(t=this._dependencies).onSessionEnd)||void 0===n||n.call(t,{type:o?"FILE_NOT_FOUND_OR_ACCESS_DENIED":"UNKNOWN",error:i})},this._userClientCounter=new Ln(n.runtime),this._presenceManager=new Yt(n.broadcastManager,n.runtime),this._undoRedoManager=new p(n.undoRedoStackManager),this._pageLifeCycleManager=new Cn({serviceScope:e,agentScheduler:n.agentScheduler,pageLifeCycleImplementations:r.pageLifeCycleImplementations,deltaManager:t.deltaManager,initialClientId:t.clientId,broadcastManager:n.broadcastManager,userClientCounter:this._userClientCounter,runtime:n.runtime,shouldFirstSaveBumpVersion:o,onSaveFailedConsistently:e=>{var t;null===(t=r.onSessionEnd)||void 0===t||t.call(r,{type:"AUTO_SAVE_FAILED_CONSISTENTLY",error:e})}}),this._pageFluidDataManager=new an({serviceScope:e,rootDirectory:n.root,sharedTree:i,undoRedoStackManager:n.undoRedoStackManager,presenceManager:this._presenceManager,pageLifeCycleManager:this._pageLifeCycleManager}),this._focusOverwrite=new U,this._userIdleStateManager=new En({presenceManager:this._presenceManager,onDisconnect:()=>Object(v.__awaiter)(this,void 0,void 0,function*(){var e;m._SPKillSwitch.isActivated("1185ed32-87f7-4df8-853b-32485e6c5b9f")&&(yield this._pageLifeCycleManager.save()),null===(e=r.onSessionEnd)||void 0===e||e.call(r,{type:"IDLE_DISCONNECT"})})}),t.on("disconnected",()=>{var e;this._hasConnectedOnce&&!t.closed&&(null===(e=r.onSessionConnectivityChange)||void 0===e||e.call(r,!1),this._reconnectMonitor=new a._QosMonitor("CoAuth.Reconnect"),window.setTimeout(()=>{this._reconnectMonitor&&!this._reconnectMonitor.hasEnded&&this._reconnectMonitor.writeUnexpectedFailure("ReconnectTimeout",new Error("Client is not reconnected after disconnecting."))},1e4))}),t.on("connected",()=>{var e;t.closed||(null===(e=r.onSessionConnectivityChange)||void 0===e||e.call(r,!0),this._reconnectMonitor&&!this._reconnectMonitor.hasEnded&&this._reconnectMonitor.writeSuccess()),!this._hasConnectedOnce&&t.deltaManager.active&&(a._EngagementLogger.logEventWithLogEntry(new a._LogEntry("CoAuth.Session","Connected",a._LogType.Event,{usersCount:String(this._userClientCounter.getUserCount()),clientsCount:String(this._userClientCounter.getClientCount()),connectedClientsCount:String(this._userClientCounter.getCurrentConnectedClientCount()),sessionId:s})),this._hasConnectedOnce=!0)}),!se()&&t.closed&&this._handleContainerClosed(),t.on("closed",this._handleContainerClosed),T.instance.addCallbackForExtraLogs("CurrentMembers",e=>{const t=[];return this._container.audience.getMembers().forEach((n,a)=>{t.push(JSON.stringify(Object.assign(Object.assign({clientId:a},n),{user:e?"<pruned>":n.user})))}),t})}static startFluidSession(e,t,n){var i;return Object(v.__awaiter)(this,void 0,void 0,function*(){Mn._instance&&(a._TraceLogger.logError(kn,new Error("Disposing a left-over fluid session. It might indicate a performance bottleneck.")),yield Mn.disposeAsync()),Object(H.t)(n.fluidBundle);const r=yield Mn._serviceSolution.getContainer(e,t,n.shouldTryCreateNewContainer),o=yield Object(H.e)().getDefaultObjectFromContainer(r),s=yield o.root,c=yield null===(i=s.get(ke.CoreAuthoring))||void 0===i?void 0:i.get();if(!c)throw new Error("Failed to initialize canvas distributed data structure in PageFluidObject");const{sessionId:d}=t;let l=!1;s.get(ke.SessionId)!==d&&(s.set(ke.SessionId,d),l=!0);const u=new Mn(e,r,o,c,n,l,d);return Mn._instance=u,u})}static disposeAsync(){return Object(v.__awaiter)(this,void 0,void 0,function*(){Mn._instance?(yield Mn._instance.disposeAsync(),delete Mn._instance):a._TraceLogger.logError(kn,new Error("There is no PageFluidOrchestrator instance to be disposed, it might indicate a memory leak in the application"))})}disposeAsync(){return this._isDisposeStarted=!0,this._container.close(),this._pageFluidDataManager.dispose(),this._undoRedoManager.dispose(),this._pageLifeCycleManager.dispose(),this._focusOverwrite.dispose(),this._userIdleStateManager.dispose(),T.dispose(),Promise.resolve()}get coreSharedTreeManager(){return this._pageFluidDataManager.core}get pageFluidDataManager(){return this._pageFluidDataManager}get undoRedoManager(){return this._undoRedoManager}get presenceManager(){return this._presenceManager}get pageLifeCycleManager(){return this._pageLifeCycleManager}get interactiveClientCount(){return this._userClientCounter.getClientCount()}}Mn._serviceSolution=_n},rAxy:function(e,t,n){"use strict";let a;function i(e){a=e}function r(){if(!a)throw new Error("Modules MUST be set before getting.");return a}n.d(t,"t",function(){return i}),n.d(t,"e",function(){return r})},sSDQ:function(e,t){e.exports=p},ut3N:function(e,t){e.exports=m},vlQI:function(e,t){e.exports=_},y88i:function(e,t){e.exports=h}})});